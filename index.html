<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <!-- Защита от копирования и инспекции -->
        <meta name="robots" content="noindex, nofollow">
        <meta name="referrer" content="no-referrer">
        <style>
            /* Запрет выделения текста и контекстного меню */
            body {
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
        </style>
        <script>
            // Защита от копирования и инспекции
            document.addEventListener('DOMContentLoaded', function() {
                // Блокировка контекстного меню
                document.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    return false;
                });
                
                // Блокировка сочетаний клавиш
                document.addEventListener('keydown', function(e) {
                    // Ctrl+U, Ctrl+S, Ctrl+Shift+I, F12
                    if (e.ctrlKey && (e.keyCode == 85 || e.keyCode == 83) || 
                        e.keyCode == 123 || 
                        (e.ctrlKey && e.shiftKey && e.keyCode == 73)) {
                        e.preventDefault();
                        return false;
                    }
                });
                
                // Защита от копирования
                document.addEventListener('copy', function(e) {
                    e.preventDefault();
                    return false;
                });
                
                // Защита от перетаскивания
                document.addEventListener('dragstart', function(e) {
                    e.preventDefault();
                    return false;
                });
            });
        </script>
    </head>
    <body>Verification: 86a1ac2c3c11e05f</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Защитные мета-теги -->
    <meta name="robots" content="noindex, nofollow">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <meta name="googlebot" content="noindex, nofollow">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com/ajax/libs; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com/ajax/libs; font-src 'self' https://cdnjs.cloudflare.com/ajax/libs; connect-src 'self';">
    <meta name="csrf-token" content="<?php echo bin2hex(random_bytes(32)); ?>">
    
    <title>Лизинговый калькулятор</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer">
    
    <style>
        /* Защита от копирования */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }
        
        /* Разрешаем выделение только для полей ввода */
        input, textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        
        body { 
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%); 
            color: #333; 
            line-height: 1.6; 
            padding: 15px; 
            min-height: 100vh;
            position: relative;
        }
        
        /* Защитный оверлей против скрапинга */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 999999;
            pointer-events: none;
            background: transparent;
        }
        
        /* Скрываем реальные данные от ботов */
        .real-data {
            position: absolute;
            left: -9999px;
            opacity: 0.001;
            height: 0;
            width: 0;
            overflow: hidden;
        }
        
        /* Остальные стили остаются без изменений */
        .container { max-width: 1100px; margin: 0 auto; background: white; border-radius: 18px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08); overflow: hidden; position: relative; z-index: 1; }
        header { 
            background: linear-gradient(to right, #1a3a5f, #2c5282); 
            color: white; 
            padding: 25px 20px; 
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        /* Защита от скрапинга текста заголовка */
        header h1::after {
            content: attr(data-protected-text);
            position: absolute;
            left: -9999px;
            opacity: 0.001;
        }
        
        header h1 { font-size: 1.8rem; margin-bottom: 8px; position: relative; }
        header p { opacity: 0.9; font-size: 1rem; }
        
        /* ... остальные стили остаются без изменений ... */
        
        /* Добавляем скрытые защитные элементы */
        .honeypot-field {
            display: none !important;
            visibility: hidden !important;
            height: 0 !important;
            width: 0 !important;
            opacity: 0 !important;
            position: absolute !important;
            left: -9999px !important;
        }
        
        /* Защита от скриншотов (только для поддерживающих браузеров) */
        @media print {
            .container {
                display: none !important;
            }
        }
        
        /* Анти-бот проверка времени заполнения формы */
        .form-timestamp {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Скрытые данные для защиты от ботов -->
    <div class="real-data">
        <div data-bot-trap="true">ignore-this-content</div>
        <div data-fake-phone="+7-XXX-XXX-XX-XX">fake-phone-number</div>
        <div data-fake-email="noreply@example.com">fake-email</div>
    </div>
    
    <!-- Защитный скрытый iframe для обнаружения кликеров -->
    <iframe src="about:blank" style="display:none; visibility:hidden; width:0; height:0;" id="bot-trap-frame"></iframe>
    
    <div class="container">
        <header>
            <h1 data-protected-text="Лизинговый калькулятор"><i class="fas fa-calculator"></i> Лизинговый калькулятор</h1>
            <p>Рассчитайте график платежей и налоговую экономию для вашего бизнеса</p>
        </header>

        <div class="calculator-wrapper">
            <section class="input-section">
                <h2 class="section-title"><i class="fas fa-sliders-h"></i> Параметры лизинга</h2>
                
                <!-- Скрытое поле-ловушка для ботов -->
                <input type="text" name="website" class="honeypot-field" autocomplete="off" tabindex="-1">
                
                <div class="input-group">
                    <div class="input-header">
                        <label for="priceInput">Стоимость техники</label>
                        <div class="value-container">
                            <span class="value" id="priceValue">1 500 000 ₽</span>
                        </div>
                    </div>
                    <div class="input-with-controls">
                        <input type="text" id="priceInput" class="money-input" value="1 500 000" data-max="100 000 000" autocomplete="off" data-protect="true">
                        <span class="input-suffix">₽</span>
                    </div>
                    <div class="range-limits"><span>0 ₽</span><span>100 000 000 ₽</span></div>
                </div>
                
                <!-- Скрытый таймстамп времени начала взаимодействия -->
                <input type="hidden" id="interaction-start" value="">
                
                <!-- ... остальной HTML код без изменений ... -->
                
                <!-- Добавляем скрытый токен для защиты форм -->
                <input type="hidden" id="form-token" name="form_token" value="">
                
            </section>

            <!-- ... остальной HTML код остается без изменений ... -->
            
        </div>
        
        <div class="disclaimer">
            * Представленный вариант расчета приблизительный, и не является конечным предложением. Для получения точного коммерческого предложения свяжитесь с нами.<br>
            Все экономические выгоды приведены в сравнении с покупкой за собственные средства. Возмещение НДС — если компания является плательщиком НДС и применяет общую систему налогообложения.
        </div>
    </div>

    <!-- Модальные окна (без изменений) -->
    <!-- ... -->

    <script>
        // ================= ЗАЩИТНЫЕ ФУНКЦИИ =================
        
        // 1. Защита от DevTools
        function detectDevTools() {
            const threshold = 160;
            const widthThreshold = window.outerWidth - window.innerWidth > threshold;
            const heightThreshold = window.outerHeight - window.innerHeight > threshold;
            
            if (widthThreshold || heightThreshold) {
                document.body.innerHTML = '<div style="padding: 50px; text-align: center; font-family: Arial;"><h2>Доступ ограничен</h2><p>Пожалуйста, отключите инструменты разработчика для использования калькулятора.</p></div>';
                throw new Error('DevTools detected');
            }
        }
        
        // 2. Проверка на бота по времени реакции
        let interactionStartTime = Date.now();
        let isHuman = false;
        
        function checkHumanInteraction() {
            const interactionTime = Date.now() - interactionStartTime;
            // Если форма отправлена слишком быстро (< 3 секунд) - это бот
            if (interactionTime < 3000) {
                console.warn('Bot detected: too fast interaction');
                return false;
            }
            return true;
        }
        
        // 3. Защита от кликеров-ботов
        let clickCount = 0;
        let lastClickTime = 0;
        
        function checkClickPattern(e) {
            const now = Date.now();
            if (now - lastClickTime < 100) { // Клики чаще чем 100мс
                clickCount++;
                if (clickCount > 5) {
                    e.preventDefault();
                    e.stopPropagation();
                    alert('Обнаружена подозрительная активность. Пожалуйста, замедлите клики.');
                    return false;
                }
            } else {
                clickCount = 0;
            }
            lastClickTime = now;
            return true;
        }
        
        // 4. Генерация защитного токена
        function generateFormToken() {
            const timestamp = Date.now();
            const random = Math.random().toString(36).substring(2);
            const userAgent = navigator.userAgent.substring(0, 50);
            return btoa(timestamp + '||' + random + '||' + userAgent).substring(0, 50);
        }
        
        // 5. Проверка на headless браузер
        function checkHeadlessBrowser() {
            // Проверка WebGL
            const canvas = document.createElement('canvas');
            const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
            if (!gl) {
                console.warn('Headless browser might be detected');
                return false;
            }
            
            // Проверка плагинов
            const pluginsLength = navigator.plugins.length;
            if (pluginsLength === 0) {
                console.warn('Possible headless browser detected');
                return false;
            }
            
            // Проверка языка
            const languages = navigator.languages;
            if (!languages || languages.length === 0) {
                console.warn('Possible headless browser detected');
                return false;
            }
            
            return true;
        }
        
        // 6. Защита от скрапинга данных
        function obfuscateData(data) {
            // Двойное кодирование данных
            return btoa(encodeURIComponent(JSON.stringify(data)));
        }
        
        function deobfuscateData(obfuscated) {
            try {
                return JSON.parse(decodeURIComponent(atob(obfuscated)));
            } catch (e) {
                console.error('Error deobfuscating data:', e);
                return null;
            }
        }
        
        // 7. Проверка на эмуляцию мыши
        let mouseMoveCount = 0;
        function checkMouseMovement() {
            document.addEventListener('mousemove', function() {
                mouseMoveCount++;
                if (mouseMoveCount > 2) {
                    isHuman = true;
                }
            }, { once: false });
        }
        
        // 8. Защита от автоматического заполнения форм
        function protectFormAutofill() {
            const form = document.querySelector('.contact-form');
            if (form) {
                form.addEventListener('input', function(e) {
                    if (e.target.matches('input, textarea, select')) {
                        // Добавляем небольшую задержку для человеческого ввода
                        setTimeout(() => {
                            e.target.setAttribute('data-last-input', Date.now());
                        }, 50);
                    }
                });
            }
        }
        
        // 9. Блокировка сочетаний клавиш
        function blockShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Ctrl+S, Ctrl+U, F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+Shift+C
                const blockedKeys = [
                    {ctrl: true, key: 's'}, // Сохранить
                    {ctrl: true, key: 'u'}, // Просмотр источника
                    {key: 'F12'}, // DevTools
                    {ctrl: true, shift: true, key: 'i'}, // DevTools
                    {ctrl: true, shift: true, key: 'j'}, // DevTools Console
                    {ctrl: true, shift: true, key: 'c'}, // DevTools Inspect
                    {ctrl: true, key: 'p'} // Печать
                ];
                
                for (const blocked of blockedKeys) {
                    const ctrlMatch = !blocked.ctrl || e.ctrlKey;
                    const shiftMatch = !blocked.shift || e.shiftKey;
                    const keyMatch = blocked.key.toLowerCase() === e.key.toLowerCase() || 
                                    blocked.key === e.key;
                    
                    if (ctrlMatch && shiftMatch && keyMatch) {
                        e.preventDefault();
                        e.stopPropagation();
                        return false;
                    }
                }
            });
        }
        
        // 10. Защита от копирования
        function protectCopying() {
            document.addEventListener('copy', function(e) {
                e.preventDefault();
                
                // Разрешаем копирование только из полей ввода
                if (e.target.matches('input, textarea')) {
                    return true;
                }
                
                // Показываем предупреждение
                alert('Копирование содержимого страницы запрещено.');
                return false;
            });
            
            document.addEventListener('cut', function(e) {
                e.preventDefault();
                return false;
            });
            
            document.addEventListener('paste', function(e) {
                // Блокируем вставку в защищенные поля
                if (e.target.hasAttribute('data-protect')) {
                    e.preventDefault();
                    alert('Вставка в это поле запрещена.');
                    return false;
                }
            });
        }
        
        // 11. Защита от перетаскивания
        function protectDragging() {
            document.addEventListener('dragstart', function(e) {
                if (!e.target.matches('input, textarea')) {
                    e.preventDefault();
                    return false;
                }
            });
        }
        
        // 12. Обнаружение автоматических скриптов
        let actionSequence = [];
        function detectAutomation() {
            const events = ['mousedown', 'mouseup', 'click', 'keydown', 'keyup', 'input'];
            
            events.forEach(eventType => {
                document.addEventListener(eventType, function(e) {
                    const now = Date.now();
                    actionSequence.push({
                        type: eventType,
                        target: e.target.tagName,
                        time: now,
                        position: e.type.includes('mouse') ? {x: e.clientX, y: e.clientY} : null
                    });
                    
                    // Храним только последние 50 действий
                    if (actionSequence.length > 50) {
                        actionSequence.shift();
                    }
                    
                    // Проверяем паттерны ботов
                    checkBotPatterns();
                }, true);
            });
        }
        
        function checkBotPatterns() {
            if (actionSequence.length < 10) return;
            
            // Проверяем слишком регулярные интервалы
            let regularIntervals = true;
            for (let i = 1; i < actionSequence.length - 1; i++) {
                const diff1 = actionSequence[i].time - actionSequence[i-1].time;
                const diff2 = actionSequence[i+1].time - actionSequence[i].time;
                if (Math.abs(diff1 - diff2) > 50) { // Разница более 50мс
                    regularIntervals = false;
                    break;
                }
            }
            
            if (regularIntervals) {
                console.warn('Bot-like pattern detected: regular intervals');
                // Можно добавить дополнительные проверки или действия
            }
            
            // Проверяем клики в одних и тех же координатах
            const clicks = actionSequence.filter(a => a.type === 'click');
            if (clicks.length > 3) {
                const firstClick = clicks[0].position;
                const samePosition = clicks.every(click => 
                    Math.abs(click.position.x - firstClick.x) < 5 && 
                    Math.abs(click.position.y - firstClick.y) < 5
                );
                
                if (samePosition) {
                    console.warn('Bot-like pattern detected: same position clicks');
                }
            }
        }
        
        // 13. Защита от iframe встраивания
        if (window.self !== window.top) {
            // Если страница загружена в iframe
            document.body.innerHTML = '<div style="padding: 50px; text-align: center;"><h2>Доступ запрещен</h2><p>Эта страница не может быть загружена во фрейме.</p></div>';
            throw new Error('Frame embedding not allowed');
        }
        
        // 14. Проверка поддержки браузером современных функций
        function checkBrowserCapabilities() {
            const requiredFeatures = [
                'querySelector',
                'addEventListener',
                'localStorage',
                'sessionStorage',
                'JSON',
                'Promise'
            ];
            
            for (const feature of requiredFeatures) {
                if (!(feature in window)) {
                    console.warn(`Browser missing feature: ${feature}`);
                    return false;
                }
            }
            return true;
        }
        
        // 15. Защита от автоматических запросов
        let lastRequestTime = 0;
        function rateLimitRequests() {
            const now = Date.now();
            if (now - lastRequestTime < 1000) { // Максимум 1 запрос в секунду
                console.warn('Rate limit exceeded');
                return false;
            }
            lastRequestTime = now;
            return true;
        }
        
        // ================= ИНИЦИАЛИЗАЦИЯ ЗАЩИТЫ =================
        document.addEventListener('DOMContentLoaded', function() {
            // Устанавливаем время начала взаимодействия
            interactionStartTime = Date.now();
            document.getElementById('interaction-start').value = interactionStartTime;
            
            // Инициализируем защитные механизмы
            detectDevTools();
            checkHumanInteraction();
            checkMouseMovement();
            protectFormAutofill();
            blockShortcuts();
            protectCopying();
            protectDragging();
            detectAutomation();
            checkBrowserCapabilities();
            
            // Генерируем и устанавливаем защитный токен
            const formToken = generateFormToken();
            document.getElementById('form-token').value = formToken;
            
            // Проверяем headless браузер
            if (!checkHeadlessBrowser()) {
                console.log('Enhanced security checks enabled');
            }
            
            // Периодическая проверка DevTools
            setInterval(detectDevTools, 1000);
            
            // ================= ОРИГИНАЛЬНЫЙ КОД КАЛЬКУЛЯТОРА =================
            // (Весь оригинальный JavaScript код калькулятора остается без изменений)
            
            // Глобальные переменные для хранения данных расчета
            let currentCalculation = {
                monthlyPayment: 0,
                totalTaxSavings: 0,
                vatSavings: 0,
                profitTaxSavings: 0,
                totalContractAmount: 0,
                carPrice: 0,
                advancePercent: 0,
                advanceAmount: 0,
                termMonths: 0,
                redemptionPercent: 0,
                redemptionAmount: 0,
                paymentSchedule: []
            };

            // Получаем элементы
            const priceInput = document.getElementById('priceInput');
            const priceValue = document.getElementById('priceValue');
            
            const advanceSlider = document.getElementById('advanceSlider');
            const advanceValue = document.getElementById('advanceValue');
            const advanceRub = document.getElementById('advanceRub');
            const advancePercentDisplay = document.getElementById('advancePercentDisplay');
            const decreaseAdvanceBtn = document.getElementById('decreaseAdvanceBtn');
            const increaseAdvanceBtn = document.getElementById('increaseAdvanceBtn');
            
            const termSlider = document.getElementById('termSlider');
            const termValue = document.getElementById('termValue');
            const termDisplay = document.getElementById('termDisplay');
            const decreaseTermBtn = document.getElementById('decreaseTermBtn');
            const increaseTermBtn = document.getElementById('increaseTermBtn');
            
            const redemptionSlider = document.getElementById('redemptionSlider');
            const redemptionValue = document.getElementById('redemptionValue');
            const redemptionRub = document.getElementById('redemptionRub');
            const redemptionPercentDisplay = document.getElementById('redemptionPercentDisplay');
            const decreaseRedemptionBtn = document.getElementById('decreaseRedemptionBtn');
            const increaseRedemptionBtn = document.getElementById('increaseRedemptionBtn');
            
            const monthlyPaymentEl = document.getElementById('monthlyPayment');
            const taxSavingEl = document.getElementById('taxSaving');
            const ndsSaveEl = document.getElementById('ndsSave');
            const profitTaxSaveEl = document.getElementById('profitTaxSave');
            const totalAmountEl = document.getElementById('totalAmount');
            
            const sendToTelegramBtn = document.getElementById('sendToTelegramBtn');
            const callBtn = document.getElementById('callBtn');
            const openScheduleBtn = document.getElementById('openScheduleBtn');
            const paymentModal = document.getElementById('paymentModal');
            const closeModal = document.getElementById('closeModal');
            const paymentScheduleContent = document.getElementById('paymentScheduleContent');
            const savePrintBtn = document.getElementById('savePrintBtn');
            
            const phoneModal = document.getElementById('phoneModal');
            const phoneNumberText = document.getElementById('phoneNumberText');
            const copyPhoneBtn = document.getElementById('copyPhoneBtn');
            const callNowBtn = document.getElementById('callNowBtn');
            const closePhoneModal = document.getElementById('closePhoneModal');
            const copySuccess = document.getElementById('copySuccess');

            // Функции форматирования
            function formatNumber(num) {
                return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
            }

            function formatCurrency(num) {
                return formatNumber(num) + ' ₽';
            }

            // Функция для форматирования ввода денег
            function formatMoneyInput(value) {
                // Удаляем все нецифры
                let cleanValue = value.replace(/\D/g, '');
                // Ограничиваем максимальное значение
                const maxValue = 100000000;
                if (parseInt(cleanValue) > maxValue) {
                    cleanValue = maxValue.toString();
                }
                // Форматируем с пробелами
                return cleanValue.replace(/\B(?=(\d{3})+(?!\d))/g, " ");
            }

            // Функция для парсинга форматированного числа
            function parseFormattedNumber(formatted) {
                return parseInt(formatted.replace(/\s/g, '')) || 0;
            }

            // Функция для расчета НДС по формуле: (цена с НДС * 22) / 122
            function calculateVAT(amountWithVAT) {
                // Формула: НДС = цена с НДС * 22 / 122
                return (amountWithVAT * 22) / 122;
            }

            // Функция для расчета налога на прибыль по формуле: (сумма с НДС - НДС) × 25%
            function calculateProfitTax(amountWithVAT, vatAmount) {
                // Формула: Налог на прибыль = (Сумма с НДС - НДС) × 25%
                const amountWithoutVAT = amountWithVAT - vatAmount;
                return amountWithoutVAT * 0.25;
            }

            // Функция для обновления отображения стоимостей в рублях под процентами
            function updateAmountDisplays() {
                const carPrice = parseFormattedNumber(priceInput.value);
                
                // Обновление аванса в рублях
                const advancePercent = parseFloat(advanceSlider.value);
                const advanceAmount = Math.round(carPrice * advancePercent / 100);
                advanceRub.textContent = formatCurrency(advanceAmount);
                advancePercentDisplay.textContent = advancePercent.toFixed(1) + '%';
                
                // Обновление выкупного платежа в рублях
                let redemptionPercent = parseFloat(redemptionSlider.value);
                // Ограничиваем максимум 15%
                if (redemptionPercent > 15) {
                    redemptionPercent = 15;
                    redemptionSlider.value = redemptionPercent;
                }
                const redemptionAmount = Math.round(carPrice * redemptionPercent / 100);
                redemptionRub.textContent = formatCurrency(redemptionAmount);
                redemptionPercentDisplay.textContent = redemptionPercent.toFixed(1) + '%';
                
                // Обновление отображения срока
                const termMonths = parseFloat(termSlider.value);
                termDisplay.textContent = termMonths + ' мес.';
            }

            // Расчет аннуитетного платежа
            function calculateAnnuity(principal, monthlyRate, months) {
                if (monthlyRate === 0) return principal / months;
                const coefficient = (monthlyRate * Math.pow(1 + monthlyRate, months)) / 
                                   (Math.pow(1 + monthlyRate, months) - 1);
                return principal * coefficient;
            }

            // Функция для генерации графика платежей с расчетом НДС и налога на прибыль
            function generatePaymentSchedule(carPrice, monthlyPayment, termMonths, advanceAmount, redemptionAmount, totalContractAmount) {
                const schedule = [];
                
                // Рассчитываем НДС и налог на прибыль для аванса
                const advanceVAT = calculateVAT(advanceAmount);
                const advanceProfitTax = calculateProfitTax(advanceAmount, advanceVAT);
                
                // Рассчитываем НДС и налог на прибыль для выкупного платежа
                const redemptionVAT = calculateVAT(redemptionAmount);
                const redemptionProfitTax = calculateProfitTax(redemptionAmount, redemptionVAT);
                
                // Рассчитываем НДС и налог на прибыль для каждого ежемесячного платежа
                const monthlyPaymentVAT = calculateVAT(monthlyPayment);
                const monthlyPaymentProfitTax = calculateProfitTax(monthlyPayment, monthlyPaymentVAT);
                
                // 1. Аванс (строка 0)
                schedule.push({
                    month: "Аванс",
                    payment: advanceAmount,
                    vat: advanceVAT,
                    profitTax: advanceProfitTax
                });
                
                // 2. Ежемесячные платежи (строки 1-N)
                for (let month = 1; month <= termMonths; month++) {
                    schedule.push({
                        month: `Месяц ${month}`,
                        payment: monthlyPayment,
                        vat: monthlyPaymentVAT,
                        profitTax: monthlyPaymentProfitTax
                    });
                }
                
                // 3. Выкупной платеж (последняя строка перед итогами)
                schedule.push({
                    month: "Выкупной платеж",
                    payment: redemptionAmount,
                    vat: redemptionVAT,
                    profitTax: redemptionProfitTax
                });
                
                // Итоговые суммы
                const totalAdvanceVAT = advanceVAT;
                const totalRedemptionVAT = redemptionVAT;
                const totalMonthlyVAT = monthlyPaymentVAT * termMonths;
                const totalVAT = totalAdvanceVAT + totalRedemptionVAT + totalMonthlyVAT;
                
                const totalAdvanceProfitTax = advanceProfitTax;
                const totalRedemptionProfitTax = redemptionProfitTax;
                const totalMonthlyProfitTax = monthlyPaymentProfitTax * termMonths;
                const totalProfitTax = totalAdvanceProfitTax + totalRedemptionProfitTax + totalMonthlyProfitTax;
                
                const totalAllPayments = advanceAmount + (monthlyPayment * termMonths) + redemptionAmount;
                
                // Сохраняем итоговые суммы
                schedule.totalAdvanceVAT = totalAdvanceVAT;
                schedule.totalRedemptionVAT = totalRedemptionVAT;
                schedule.totalMonthlyVAT = totalMonthlyVAT;
                schedule.totalVAT = totalVAT;
                
                schedule.totalAdvanceProfitTax = totalAdvanceProfitTax;
                schedule.totalRedemptionProfitTax = totalRedemptionProfitTax;
                schedule.totalMonthlyProfitTax = totalMonthlyProfitTax;
                schedule.totalProfitTax = totalProfitTax;
                
                schedule.totalAllPayments = totalAllPayments;
                
                return schedule;
            }

            // Основная функция расчетов
            function calculateLeasing() {
                // Проверяем лимит запросов
                if (!rateLimitRequests()) {
                    return;
                }
                
                // Получаем значения
                const carPrice = parseFormattedNumber(priceInput.value);
                // Минимальная стоимость теперь 0 вместо 500000
                if (carPrice < 0) {
                    priceInput.value = '0';
                    return;
                }
                
                // Получаем аванс (только проценты)
                const advancePercent = parseFloat(advanceSlider.value);
                const advanceAmount = carPrice * advancePercent / 100;
                
                // Получаем выкупной платеж (только проценты)
                let redemptionPercent = parseFloat(redemptionSlider.value);
                // Ограничиваем максимум 15%
                if (redemptionPercent > 15) {
                    redemptionPercent = 15;
                    redemptionSlider.value = redemptionPercent;
                }
                const redemptionAmount = carPrice * redemptionPercent / 100;
                
                const termMonths = parseFloat(termSlider.value);

                // Параметры
                const annualRate = 0.15;       // Годовая ставка 15%
                const commissionRate = 0.08;   // Комиссия 8% годовых
                const insuranceRate = 0.05;    // Страховка 5% годовых
                const serviceFee = 50000;      // Единовременная комиссия
                const markup = 1.03;           // Надбавка 3%

                // Расчет финансируемой стоимости
                const financedAmount = carPrice - advanceAmount - redemptionAmount;
                if (financedAmount < 0) {
                    // Если стоимость отрицательная, корректируем выкупной платеж
                    const newRedemptionAmount = carPrice - advanceAmount;
                    const newRedemptionPercent = (newRedemptionAmount / carPrice * 100);
                    if (newRedemptionPercent > 15) {
                        // Если все равно больше 15%, устанавливаем 15%
                        redemptionPercent = 15;
                        redemptionAmount = carPrice * redemptionPercent / 100;
                    } else {
                        redemptionPercent = newRedemptionPercent;
                        redemptionAmount = newRedemptionAmount;
                    }
                    redemptionSlider.value = redemptionPercent.toFixed(2);
                }

                // Расчет ежемесячных компонентов
                const monthlyRate = annualRate / 12;
                let basePayment = 0;
                if (financedAmount > 0 && termMonths > 0) {
                    basePayment = calculateAnnuity(financedAmount, monthlyRate, termMonths);
                }
                
                // Дополнительные расходы
                const insuranceMonthly = carPrice * insuranceRate / 12;
                const averageDebt = financedAmount / 2;
                const commissionMonthly = averageDebt * commissionRate / 12;
                
                // Базовая стоимость платежа
                let baseMonthlyPayment = basePayment + insuranceMonthly + commissionMonthly + (serviceFee / termMonths);
                
                // Финальный платеж с учетом надбавки
                let finalMonthlyPayment = baseMonthlyPayment * markup;

                // Расчет общих стоимостей
                const totalMonthlyPayments = finalMonthlyPayment * termMonths;
                const totalContractAmount = advanceAmount + totalMonthlyPayments + redemptionAmount;

                // Расчет налоговой экономии по правильным формулам
                // 1. НДС к возмещению по формуле: (общая стоимость договора * 22) / 122
                const vatSavings = calculateVAT(totalContractAmount);
                
                // 2. Налог на прибыль по формуле: (общая стоимость договора - НДС) × 25%
                const profitTaxSavings = calculateProfitTax(totalContractAmount, vatSavings);
                
                // Общая налоговая экономия
                const totalTaxSavings = vatSavings + profitTaxSavings;

                // Генерация графика платежей с расчетом НДС и налога на прибыль для каждого платежа
                const paymentSchedule = generatePaymentSchedule(carPrice, finalMonthlyPayment, termMonths, advanceAmount, redemptionAmount, totalContractAmount);

                // Сохранение данных (с обфускацией для безопасности)
                currentCalculation = {
                    monthlyPayment: finalMonthlyPayment,
                    totalTaxSavings: totalTaxSavings,
                    vatSavings: vatSavings,
                    profitTaxSavings: profitTaxSavings,
                    totalContractAmount: totalContractAmount,
                    carPrice: carPrice,
                    advancePercent: advancePercent,
                    advanceAmount: advanceAmount,
                    termMonths: termMonths,
                    redemptionPercent: redemptionPercent,
                    redemptionAmount: redemptionAmount,
                    paymentSchedule: paymentSchedule,
                    totalAllPayments: paymentSchedule.totalAllPayments,
                    // Добавляем защитный токен
                    securityToken: document.getElementById('form-token').value,
                    timestamp: Date.now()
                };

                // Обновление интерфейса
                monthlyPaymentEl.textContent = carPrice > 0 ? formatCurrency(finalMonthlyPayment) : "0 ₽";
                taxSavingEl.textContent = carPrice > 0 ? formatCurrency(totalTaxSavings) : "0 ₽";
                ndsSaveEl.textContent = carPrice > 0 ? formatCurrency(vatSavings) : "0 ₽";
                profitTaxSaveEl.textContent = carPrice > 0 ? formatCurrency(profitTaxSavings) : "0 ₽";
                totalAmountEl.textContent = formatCurrency(totalContractAmount);
                
                // Обновление отображаемых значений
                priceValue.textContent = formatCurrency(carPrice);
                advanceValue.textContent = advancePercent.toFixed(1) + '%';
                redemptionValue.textContent = redemptionPercent.toFixed(1) + '%';
                termValue.textContent = termMonths;
                
                // Обновление стоимостей в рублях под процентами
                updateAmountDisplays();
            }

            // Защищенная функция для копирования номера телефона
            function copyPhoneNumber() {
                // Проверяем, что это человеческое действие
                if (!checkClickPattern(event)) return;
                
                const phoneNumber = '89990387395';
                
                // Используем новое Clipboard API с обработкой ошибок
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(phoneNumber)
                        .then(() => {
                            showCopySuccess();
                        })
                        .catch(err => {
                            console.error('Ошибка копирования через Clipboard API:', err);
                            fallbackCopy(phoneNumber);
                        });
                } else {
                    fallbackCopy(phoneNumber);
                }
            }
            
            function fallbackCopy(text) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-9999px';
                textArea.style.top = '-9999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        showCopySuccess();
                    } else {
                        alert('Не удалось скопировать номер. Пожалуйста, скопируйте вручную: ' + text);
                    }
                } catch (err) {
                    console.error('Ошибка при копировании:', err);
                    alert('Не удалось скопировать номер. Пожалуйста, скопируйте вручную: ' + text);
                }
                
                document.body.removeChild(textArea);
            }
            
            function showCopySuccess() {
                copySuccess.style.display = 'block';
                setTimeout(() => {
                    copySuccess.style.display = 'none';
                }, 2000);
            }

            // Функция для отображения графика платежей
            function showPaymentSchedule() {
                // Проверяем человеческое взаимодействие
                if (!checkHumanInteraction()) {
                    alert('Пожалуйста, подождите несколько секунд перед открытием графика.');
                    return;
                }
                
                const schedule = currentCalculation.paymentSchedule;
                let html = `
                    <div style="margin-bottom: 18px; background: #f0f7ff; padding: 14px; border-radius: 10px; font-size: 0.9rem;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                            <div>
                                <strong>Ежемесячный платеж:</strong><br>
                                ${formatCurrency(currentCalculation.monthlyPayment)}
                            </div>
                            <div>
                                <strong>Общая стоимость договора:</strong><br>
                                ${formatCurrency(currentCalculation.totalContractAmount)}
                            </div>
                        </div>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table class="payment-table">
                            <thead>
                                <tr>
                                    <th>Платеж</th>
                                    <th>Сумма платежа</th>
                                    <th>НДС к возмещению</th>
                                    <th>Налог на прибыль</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                schedule.forEach(item => {
                    html += `
                        <tr>
                            <td class="month">${item.month}</td>
                            <td>${formatCurrency(item.payment)}</td>
                            <td class="vat-amount">${formatCurrency(item.vat)}</td>
                            <td class="profit-tax-amount">${formatCurrency(item.profitTax)}</td>
                        </tr>`;
                });
                
                // Итоговые строки
                const totalAllPayments = schedule.totalAllPayments || currentCalculation.totalContractAmount;
                const totalVAT = schedule.totalVAT || currentCalculation.vatSavings;
                const totalProfitTax = schedule.totalProfitTax || currentCalculation.profitTaxSavings;
                
                html += `
                            </tbody>
                            <tfoot>
                                <tr class="total-row">
                                    <td>Итого</td>
                                    <td>${formatCurrency(totalAllPayments)}</td>
                                    <td>${formatCurrency(totalVAT)}</td>
                                    <td>${formatCurrency(totalProfitTax)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <div style="margin-top: 18px; padding: 14px; background: #f8fafc; border-radius: 10px; font-size: 0.85rem; color: #4a5568;">
                        <strong>Внимание:</strong> Представленный вариант расчета приблизительный, и не является конечным предложением. Для получения точного коммерческого предложения свяжитесь с нами.<br>
                        <strong>Расчет НДС:</strong> НДС к возмещению рассчитывается по формуле: (стоимость с НДС × 22) ÷ 122<br>
                        <strong>Расчет налога на прибыль:</strong> Налог на прибыль рассчитывается по формуле: (Сумма с НДС - НДС) × 25%<br>
                        Все экономические выгоды приведены в сравнении с покупкой за собственные средства. Возмещение НДС — если компания является плательщиком НДС и применяет общую систему налогообложения.
                    </div>`;
                
                paymentScheduleContent.innerHTML = html;
                paymentModal.style.display = 'flex';
            }

            // Защищенная функция для сохранения и печати
            function saveAndPrint() {
                // Проверяем человеческое взаимодействие
                if (!checkHumanInteraction()) {
                    alert('Пожалуйста, подождите несколько секунд перед сохранением.');
                    return;
                }
                
                try {
                    // Проверяем наличие jsPDF
                    if (typeof window.jspdf !== 'undefined') {
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF('p', 'mm', 'a4');
                        
                        doc.setFont("helvetica");
                        
                        // Заголовок
                        doc.setFontSize(18);
                        doc.setTextColor(26, 58, 95);
                        doc.text("График платежей по лизингу", 105, 20, { align: "center" });
                        
                        doc.setFontSize(11);
                        doc.setTextColor(100, 100, 100);
                        doc.text(`Дата формирования: ${new Date().toLocaleDateString('ru-RU')}`, 105, 30, { align: "center" });
                        
                        // Информация о расчете
                        doc.setFontSize(13);
                        doc.setTextColor(26, 58, 95);
                        doc.text("Параметры расчета:", 20, 45);
                        
                        doc.setFontSize(10);
                        doc.setTextColor(0, 0, 0);
                        let yPos = 55;
                        
                        const params = [
                            `Стоимость техники: ${formatCurrency(currentCalculation.carPrice)}`,
                            `Первоначальный взнос: ${currentCalculation.advancePercent.toFixed(1)}% (${formatCurrency(currentCalculation.advanceAmount)})`,
                            `Срок договора: ${currentCalculation.termMonths} месяцев`,
                            `Выкупной платеж: ${currentCalculation.redemptionPercent.toFixed(1)}% (${formatCurrency(currentCalculation.redemptionAmount)})`,
                            `Ежемесячный платеж: ${formatCurrency(currentCalculation.monthlyPayment)}`,
                            `Общая стоимость договора: ${formatCurrency(currentCalculation.totalContractAmount)}`
                        ];
                        
                        params.forEach(param => {
                            doc.text("• " + param, 25, yPos);
                            yPos += 6;
                        });
                        
                        // График платежей
                        yPos += 8;
                        doc.setFontSize(13);
                        doc.setTextColor(26, 58, 95);
                        doc.text("График платежей:", 20, yPos);
                        yPos += 8;
                        
                        // Заголовок таблицы
                        doc.setFontSize(10);
                        doc.setTextColor(255, 255, 255);
                        doc.setFillColor(44, 82, 130);
                        doc.rect(20, yPos, 170, 8, 'F');
                        doc.text("Платеж", 25, yPos + 5);
                        doc.text("Сумма", 60, yPos + 5);
                        doc.text("НДС", 100, yPos + 5);
                        doc.text("Налог на прибыль", 150, yPos + 5, { align: "right" });
                        
                        yPos += 12;
                        
                        // Данные таблицы
                        const schedule = currentCalculation.paymentSchedule;
                        for (let i = 0; i < schedule.length; i++) {
                            const item = schedule[i];
                            
                            if (yPos > 270 && i > 0) {
                                doc.addPage();
                                yPos = 20;
                            }
                            
                            doc.setTextColor(0, 0, 0);
                            doc.text(item.month, 25, yPos);
                            doc.text(formatCurrency(item.payment), 60, yPos);
                            doc.text(formatCurrency(item.vat), 100, yPos);
                            doc.text(formatCurrency(item.profitTax), 150, yPos, { align: "right" });
                            
                            yPos += 8;
                        }
                        
                        // Итоговые строки
                        yPos += 5;
                        doc.setFillColor(240, 247, 255);
                        doc.rect(20, yPos, 170, 8, 'F');
                        doc.setFontSize(11);
                        doc.setTextColor(26, 58, 95);
                        doc.setFontStyle("bold");
                        doc.text("Итого", 25, yPos + 5);
                        doc.text(formatCurrency(schedule.totalAllPayments), 60, yPos + 5);
                        doc.text(formatCurrency(schedule.totalVAT), 100, yPos + 5);
                        doc.text(formatCurrency(schedule.totalProfitTax), 150, yPos + 5, { align: "right" });
                        
                        // Сохраняем PDF с защищенным именем
                        const timestamp = new Date().getTime();
                        const randomId = Math.random().toString(36).substring(2, 10);
                        const fileName = `leasing_schedule_${timestamp}_${randomId}.pdf`;
                        doc.save(fileName);
                        
                        // После сохранения PDF, открываем диалог печати
                        setTimeout(() => {
                            printSchedule();
                        }, 1000);
                        
                    } else {
                        // Если библиотека jsPDF не загружена, просто печатаем
                        printSchedule();
                    }
                    
                } catch (error) {
                    console.error("Ошибка при сохранении PDF:", error);
                    alert('Ошибка при сохранении файла. Пожалуйста, попробуйте еще раз.');
                }
            }

            // Функция для печати
            function printSchedule() {
                const printWindow = window.open('', '_blank');
                if (!printWindow) {
                    alert('Пожалуйста, разрешите всплывающие окна для печати графика.');
                    return;
                }
                
                printWindow.document.write(`
                    <html>
                        <head>
                            <title>График платежей по лизингу</title>
                            <style>
                                @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
                                body { font-family: 'Roboto', Arial, sans-serif; padding: 15px; font-size: 14px; }
                                h1 { color: #1a3a5f; font-size: 1.5rem; }
                                table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
                                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                                th { background-color: #f2f2f2; }
                                .total-row { font-weight: bold; background-color: #e6f3ff; }
                                .note { margin-top: 15px; padding: 10px; background: #f8fafc; border-radius: 5px; font-size: 12px; color: #4a5568; }
                                @media print {
                                    body { padding: 10px; font-size: 12px; }
                                    .no-print { display: none; }
                                    table { font-size: 11px; }
                                }
                            </style>
                        </head>
                        <body>
                            <h1>График платежей по лизингу</h1>
                            <div style="margin-bottom: 15px; font-size: 13px;">
                                <strong>Дата генерации:</strong> ${new Date().toLocaleDateString('ru-RU')}<br>
                                <strong>Ежемесячный платеж:</strong> ${formatCurrency(currentCalculation.monthlyPayment)}<br>
                                <strong>Общая стоимость договора:</strong> ${formatCurrency(currentCalculation.totalContractAmount)}
                            </div>
                            ${paymentScheduleContent.innerHTML}
                            <div class="no-print" style="margin-top: 15px; font-style: italic; font-size: 12px;">
                                Сгенерировано лизинговым калькулятором
                            </div>
                        </body>
                    </html>
                `);
                printWindow.document.close();
                
                // Даем время на загрузку
                setTimeout(() => {
                    printWindow.focus();
                    printWindow.print();
                    printWindow.onafterprint = function() {
                        printWindow.close();
                    };
                }, 500);
            }

            // Настройка обработчиков событий с защитой
            function setupEventListeners() {
                // Обработчик для ввода стоимости техники с защитой от быстрого ввода
                let lastInputTime = 0;
                priceInput.addEventListener('input', function(e) {
                    const now = Date.now();
                    if (now - lastInputTime < 50) { // Ограничение 50мс между вводами
                        return;
                    }
                    lastInputTime = now;
                    
                    this.value = formatMoneyInput(this.value);
                    calculateLeasing();
                });
                
                priceInput.addEventListener('blur', function() {
                    if (!this.value) {
                        this.value = '0';
                    }
                    calculateLeasing();
                });

                // Обработчики для аванса с защитой
                advanceSlider.addEventListener('input', function() {
                    const percent = parseFloat(this.value);
                    advanceValue.textContent = percent.toFixed(1) + '%';
                    updateAmountDisplays();
                    calculateLeasing();
                });

                // Кнопки управления авансом с защитой от быстрых кликов
                decreaseAdvanceBtn.addEventListener('click', function(e) {
                    if (!checkClickPattern(e)) return;
                    
                    let currentValue = parseFloat(advanceSlider.value);
                    if (currentValue > 5) {
                        currentValue = Math.max(5, currentValue - 1);
                        advanceSlider.value = currentValue;
                        advanceSlider.dispatchEvent(new Event('input'));
                    }
                });

                increaseAdvanceBtn.addEventListener('click', function(e) {
                    if (!checkClickPattern(e)) return;
                    
                    let currentValue = parseFloat(advanceSlider.value);
                    if (currentValue < 50) {
                        currentValue = Math.min(50, currentValue + 1);
                        advanceSlider.value = currentValue;
                        advanceSlider.dispatchEvent(new Event('input'));
                    }
                });

                // Обработчики для срока с защитой
                termSlider.addEventListener('input', function() {
                    const term = parseFloat(this.value);
                    termValue.textContent = term;
                    updateAmountDisplays();
                    calculateLeasing();
                });

                // Кнопки управления сроком с защитой
                decreaseTermBtn.addEventListener('click', function(e) {
                    if (!checkClickPattern(e)) return;
                    
                    let currentValue = parseFloat(termSlider.value);
                    if (currentValue > 6) {
                        currentValue = Math.max(6, currentValue - 6);
                        termSlider.value = currentValue;
                        termSlider.dispatchEvent(new Event('input'));
                    }
                });

                increaseTermBtn.addEventListener('click', function(e) {
                    if (!checkClickPattern(e)) return;
                    
                    let currentValue = parseFloat(termSlider.value);
                    if (currentValue < 60) {
                        currentValue = Math.min(60, currentValue + 6);
                        termSlider.value = currentValue;
                        termSlider.dispatchEvent(new Event('input'));
                    }
                });

                // Обработчики для выкупного платежа с защитой
                redemptionSlider.addEventListener('input', function() {
                    let percent = parseFloat(this.value);
                    // Ограничиваем максимум 15%
                    if (percent > 15) {
                        percent = 15;
                        this.value = percent;
                    }
                    redemptionValue.textContent = percent.toFixed(1) + '%';
                    updateAmountDisplays();
                    calculateLeasing();
                });

                // Кнопки управления выкупным платежом с защитой
                decreaseRedemptionBtn.addEventListener('click', function(e) {
                    if (!checkClickPattern(e)) return;
                    
                    let currentValue = parseFloat(redemptionSlider.value);
                    if (currentValue > 0) {
                        currentValue = Math.max(0, currentValue - 1);
                        redemptionSlider.value = currentValue;
                        redemptionSlider.dispatchEvent(new Event('input'));
                    }
                });

                increaseRedemptionBtn.addEventListener('click', function(e) {
                    if (!checkClickPattern(e)) return;
                    
                    let currentValue = parseFloat(redemptionSlider.value);
                    if (currentValue < 15) {
                        currentValue = Math.min(15, currentValue + 1);
                        redemptionSlider.value = currentValue;
                        redemptionSlider.dispatchEvent(new Event('input'));
                    }
                });

                // Маска для телефона с защитой от автоматического заполнения
                const phoneInput = document.getElementById('phone');
                phoneInput.addEventListener('input', function(e) {
                    let x = e.target.value.replace(/\D/g, '').match(/(\d{0,1})(\d{0,3})(\d{0,3})(\d{0,2})(\d{0,2})/);
                    e.target.value = !x[2] ? x[1] : '+7 (' + x[2] + ') ' + x[3] + (x[4] ? '-' + x[4] : '') + (x[5] ? '-' + x[5] : '');
                });

                // Фокус на поле телефона
                phoneInput.addEventListener('focus', function() {
                    if (this.value === '+7 (') {
                        this.setSelectionRange(4, 4);
                    }
                });

                // Обработчики для кнопок отправки и сохранения с защитой
                sendToTelegramBtn.addEventListener('click', function(e) {
                    if (!checkClickPattern(e)) return;
                    if (!checkHumanInteraction()) {
                        alert('Пожалуйста, подождите несколько секунд перед отправкой.');
                        return;
                    }
                    sendToTelegram();
                });
                
                callBtn.addEventListener('click', function(e) {
                    if (!checkClickPattern(e)) return;
                    phoneModal.style.display = 'flex';
                });
                
                openScheduleBtn.addEventListener('click', function(e) {
                    if (!checkClickPattern(e)) return;
                    showPaymentSchedule();
                });
                
                // Обработчики модального окна графика с защитой
                closeModal.addEventListener('click', function(e) {
                    if (!checkClickPattern(e)) return;
                    paymentModal.style.display = 'none';
                });
                
                paymentModal.addEventListener('click', function(e) {
                    if (e.target === paymentModal) {
                        paymentModal.style.display = 'none';
                    }
                });
                
                // Обработчик для кнопки "Сохранить и печать" с защитой
                savePrintBtn.addEventListener('click', function(e) {
                    if (!checkClickPattern(e)) return;
                    saveAndPrint();
                });
                
                // Обработчики модального окна телефона с защитой
                copyPhoneBtn.addEventListener('click', function(e) {
                    if (!checkClickPattern(e)) return;
                    copyPhoneNumber();
                });
                
                closePhoneModal.addEventListener('click', function(e) {
                    if (!checkClickPattern(e)) return;
                    phoneModal.style.display = 'none';
                });
                
                phoneModal.addEventListener('click', function(e) {
                    if (e.target === phoneModal) {
                        phoneModal.style.display = 'none';
                    }
                });
                
                // Глобальная защита от клавиш
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        paymentModal.style.display = 'none';
                        phoneModal.style.display = 'none';
                    }
                });
            }

            // Защищенная функция для отправки в Telegram
            function sendToTelegram() {
                const name = document.getElementById('name').value.trim();
                const phone = document.getElementById('phone').value.trim();
                const inn = document.getElementById('inn').value.trim();
                
                // Проверка обязательных полей
                if (!name || !phone) {
                    alert('Пожалуйста, заполните обязательные поля: имя и телефон');
                    return;
                }
                
                // Проверка формата телефона
                const phoneRegex = /^\+7 \(\d{3}\) \d{3}-\d{2}-\d{2}$/;
                if (!phoneRegex.test(phone)) {
                    alert('Пожалуйста, введите корректный номер телефона');
                    return;
                }
                
                // Проверка ИНН (если заполнен)
                if (inn && !/^\d{10,12}$/.test(inn)) {
                    alert('ИНН должен содержать 10 или 12 цифр');
                    return;
                }
                
                // Проверка времени заполнения формы (минимум 3 секунды)
                const formStartTime = parseInt(document.getElementById('interaction-start').value) || interactionStartTime;
                const formFillTime = Date.now() - formStartTime;
                
                if (formFillTime < 3000) {
                    alert('Пожалуйста, заполняйте форму более внимательно. Минимальное время заполнения - 3 секунды.');
                    return;
                }
                
                // Проверка защитного токена
                const formToken = document.getElementById('form-token').value;
                if (!formToken) {
                    alert('Ошибка безопасности. Пожалуйста, обновите страницу и попробуйте снова.');
                    return;
                }
                
                const message = `Здравствуйте! Я хочу рассчитать лизинг:

💼 *Параметры расчета:*
• Стоимость техники: ${formatCurrency(currentCalculation.carPrice)}
• Первоначальный взнос: ${currentCalculation.advancePercent.toFixed(1)}% (${formatCurrency(currentCalculation.advanceAmount)})
• Срок договора: ${currentCalculation.termMonths} мес.
• Выкупной платеж: ${currentCalculation.redemptionPercent.toFixed(1)}% (${formatCurrency(currentCalculation.redemptionAmount)})

📊 *Результаты расчета:*
• Ежемесячный платеж: ${formatCurrency(currentCalculation.monthlyPayment)}
• Налоговая экономия: ${formatCurrency(currentCalculation.totalTaxSavings)}
• Общая стоимость договора: ${formatCurrency(currentCalculation.totalContractAmount)}

👤 *Мои данные:*
• Имя: ${name}
• Телефон: ${phone}
${inn ? `• ИНН: ${inn}` : ''}

*Защитные данные:*
• Время заполнения: ${Math.round(formFillTime/1000)} сек.
• Токен сессии: ${formToken.substring(0, 10)}...

Хочу получить подробное коммерческое предложение!`;

                const encodedMessage = encodeURIComponent(message);
                const telegramUrl = `https://t.me/YWeliQ?text=${encodedMessage}`;
                
                // Открываем в новом окне
                const newWindow = window.open(telegramUrl, '_blank', 'noopener,noreferrer');
                if (newWindow) {
                    newWindow.opener = null;
                }
                
                // Показываем подтверждение
                alert('Открываю Telegram... Если Telegram не открылся, пожалуйста, проверьте, установлено ли приложение или используйте веб-версию.');
            }

            // Инициализация при загрузке
            function initializeCalculator() {
                // Инициализация ИНН
                const innInput = document.getElementById('inn');
                innInput.addEventListener('input', function() {
                    this.value = this.value.replace(/\D/g, '').slice(0, 12);
                });
                
                // Настройка обработчиков событий
                setupEventListeners();
                
                // Первоначальный расчет
                calculateLeasing();
                
                // Установка курсора в поле телефона
                const phoneInput = document.getElementById('phone');
                phoneInput.value = '+7 (';
                setTimeout(() => {
                    phoneInput.focus();
                    phoneInput.setSelectionRange(4, 4);
                }, 100);
                
                // Логируем успешную инициализацию
                console.log('Калькулятор лизинга успешно инициализирован с защитой от ботов');
            }
            
            // Запускаем инициализацию
            initializeCalculator();
        });
    </script>
</body>
</html>
