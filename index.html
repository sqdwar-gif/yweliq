<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    
    <title>Лизинговый калькулятор</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { 
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%); 
            color: #333; 
            line-height: 1.6; 
            padding: 15px; 
            min-height: 100vh;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        /* Защита от выделения текста */
        .container, .input-section, .result-section, .modal-content, .phone-modal-content {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        .container { 
            max-width: 1100px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 18px; 
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08); 
            overflow: hidden;
            position: relative;
        }
        
        /* Защитные поля */
        .honeypot-field {
            display: none !important;
            position: absolute !important;
            left: -9999px !important;
            opacity: 0 !important;
            height: 0 !important;
            width: 0 !important;
        }
        
        /* Анти-копирование */
        .no-copy {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* Верхние иконки - синий Telegram и зеленый телефон */
        .header-icons {
            position: absolute;
            right: 20px;
            top: 25px;
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .header-icon-link {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            text-decoration: none;
            transition: all 0.3s ease;
            font-size: 1.3rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        /* Синий Telegram с белым самолетиком */
        .telegram-icon {
            background: #0088cc;
            color: white;
        }
        
        /* Зеленый телефон */
        .phone-icon {
            background: #38a169;
            color: white;
        }
        
        .header-icon-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .telegram-icon:hover {
            background: #0077b5;
        }
        
        .phone-icon:hover {
            background: #2f855a;
        }
        
        @media (max-width: 768px) {
            .header-icons {
                position: static;
                justify-content: center;
                margin-top: 15px;
            }
            .header-icon-link {
                width: 48px;
                height: 48px;
                font-size: 1.4rem;
            }
        }
        
        header { 
            background: linear-gradient(to right, #1a3a5f, #2c5282); 
            color: white; 
            padding: 25px 20px; 
            text-align: center;
            position: relative;
        }
        header h1 { 
            font-size: 1.8rem; 
            margin-bottom: 8px;
            cursor: default;
        }
        header p { 
            opacity: 0.9; 
            font-size: 1rem;
            cursor: default;
        }
        
        .calculator-wrapper { 
            display: grid; 
            grid-template-columns: 1.2fr 0.8fr; 
            gap: 25px; 
            padding: 25px; 
        }
        @media (max-width: 768px) { 
            .calculator-wrapper { 
                grid-template-columns: 1fr; 
                gap: 20px; 
            }
        }
        .input-section, .result-section { 
            background: #f8fafc; 
            padding: 22px; 
            border-radius: 14px; 
            border: 1px solid #e2e8f0;
            cursor: default;
        }
        
        /* Уменьшаем шрифты разделов */
        .section-title { 
            font-size: 1rem;
            color: #1a3a5f; 
            margin-bottom: 18px;
            padding-bottom: 6px;
            border-bottom: 2px solid #e2e8f0; 
            display: flex; 
            align-items: center; 
            gap: 8px;
            cursor: default;
        }
        
        .input-group { 
            margin-bottom: 18px; 
        }
        .input-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 6px;
            cursor: default;
        }
        .input-header label { 
            font-weight: 600; 
            color: #2d3748; 
            font-size: 0.9rem;
            cursor: default;
        }
        
        /* Стоимость техники - без диапазона */
        .price-input-container {
            margin-top: 8px;
        }
        
        .range-slider { 
            width: 100%; 
            height: 8px; 
            -webkit-appearance: none; 
            background: #cbd5e0; 
            border-radius: 5px; 
            outline: none; 
            margin-bottom: 5px;
            cursor: pointer;
        }
        .range-slider::-webkit-slider-thumb { 
            -webkit-appearance: none; 
            width: 22px; 
            height: 22px; 
            background: #2c5282; 
            border-radius: 50%; 
            cursor: pointer; 
            border: 3px solid white; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
        }
        
        /* Убираем отображение диапазона для стоимости техники */
        .range-limits { 
            display: flex; 
            justify-content: space-between; 
            margin-top: 5px; 
            font-size: 0.75rem; 
            color: #718096;
            cursor: default;
        }
        
        /* Скрываем диапазон для стоимости техники */
        .price-slider-container .range-limits {
            display: none;
        }
        
        .input-with-controls { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
        }
        .money-input { 
            width: 100%; 
            max-width: 200px;
            padding: 10px 12px;
            border: 1px solid #cbd5e0; 
            border-radius: 10px; 
            font-size: 0.95rem;
            font-weight: 600;
            color: #1a3a5f;
            text-align: right;
            letter-spacing: 0.5px;
            cursor: text;
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }
        @media (max-width: 768px) {
            .money-input { 
                max-width: 100%; 
            }
        }
        .money-input:focus { 
            outline: none; 
            border-color: #2c5282; 
            box-shadow: 0 0 0 3px rgba(44, 82, 130, 0.1); 
        }
        .input-suffix { 
            font-weight: 600; 
            color: #4a5568; 
            white-space: nowrap;
            font-size: 0.9rem;
            cursor: default;
        }
        
        /* Для процентов - сохраняем отображение */
        .percent-input-container {
            display: flex;
            flex-direction: column;
        }
        
        .percent-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            cursor: default;
        }
        
        .percent-display .value { 
            font-weight: 600;
            color: #4a5568;
            font-size: 0.9rem; 
            text-align: right;
            cursor: default;
        }
        
        .percent-display .value-rub { 
            font-weight: 500;
            color: #718096;
            font-size: 0.7rem;
            text-align: right;
            padding: 0;
            cursor: default;
        }
        
        /* Уменьшаем шрифты в результатах */
        .result-box { 
            background: white; 
            border-radius: 12px; 
            padding: 16px; 
            margin-bottom: 16px; 
            border-left: 5px solid #2c5282; 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.03);
            cursor: default;
        }
        .result-main { 
            border-left-color: #e67e22; 
            background: linear-gradient(to right, #fffaf0, #fff5e6); 
        }
        .result-label { 
            font-size: 0.85rem; 
            color: #4a5568; 
            margin-bottom: 4px;
            cursor: default;
        }
        .result-value { 
            font-size: 1.4rem; 
            font-weight: 800; 
            color: #1a3a5f;
            cursor: default;
        }
        .result-note { 
            font-size: 0.75rem; 
            color: #e67e22; 
            margin-top: 6px; 
            font-style: italic;
            cursor: default;
        }
        .result-sub { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
            margin-top: 18px; 
        }
        .disclaimer { 
            font-size: 0.7rem; 
            color: #718096; 
            text-align: center; 
            margin-top: 20px; 
            padding: 10px; 
            border-top: 1px solid #e2e8f0; 
            line-height: 1.5;
            cursor: default;
        }
        .info-icon { 
            color: #2c5282; 
            margin-left: 5px; 
            cursor: help; 
            font-size: 0.85rem; 
        }
        .contact-form { 
            margin-top: 20px; 
        }
        .form-group { 
            margin-bottom: 16px; 
        }
        .form-group label { 
            display: block; 
            margin-bottom: 6px; 
            font-weight: 600; 
            color: #2d3748; 
            font-size: 0.9rem;
            cursor: default;
        }
        .form-group input { 
            width: 100%; 
            padding: 10px 12px;
            border: 1px solid #cbd5e0; 
            border-radius: 10px; 
            font-size: 0.95rem;
            transition: all 0.3s ease;
            cursor: text;
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }
        .form-group input:focus { 
            outline: none; 
            border-color: #2c5282; 
            box-shadow: 0 0 0 3px rgba(44, 82, 130, 0.1); 
        }
        
        /* Поле телефона со скрытой скобкой */
        .phone-input {
            width: 100%;
            padding: 10px 12px !important;
            border: 1px solid #cbd5e0;
            border-radius: 10px;
            font-size: 0.95rem;
            /* Убираем видимость скобок */
            letter-spacing: 0;
            cursor: text;
            user-select: text;
        }
        
        /* Поле ИНН */
        .inn-input {
            width: 100%;
            padding: 10px 12px !important;
            border: 1px solid #cbd5e0;
            border-radius: 10px;
            font-size: 0.95rem;
            cursor: text;
            user-select: text;
        }
        
        /* Скрываем скобки в номере телефона */
        .phone-input::placeholder {
            color: #a0aec0;
            letter-spacing: 0;
        }
        
        .form-row { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
        }
        .form-optional { 
            color: #718096; 
            font-size: 0.8rem;
            cursor: default;
        }
        
        /* Стили для чекбокса согласия */
        .checkbox-group {
            margin: 20px 0;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            cursor: default;
        }
        
        .checkbox-container {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            cursor: default;
        }
        
        .checkbox-container input[type="checkbox"] {
            margin-top: 3px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .checkbox-label {
            font-size: 0.85rem;
            color: #4a5568;
            line-height: 1.4;
            cursor: pointer;
        }
        
        .checkbox-label a {
            color: #2c5282;
            text-decoration: none;
        }
        
        .checkbox-label a:hover {
            text-decoration: underline;
        }
        
        .tax-savings-compact {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 16px;
            cursor: default;
        }
        @media (max-width: 480px) {
            .tax-savings-compact { 
                grid-template-columns: 1fr; 
            }
        }
        .tax-savings-item {
            background: white;
            border-radius: 10px;
            padding: 10px;
            border: 1px solid #e2e8f0;
            text-align: center;
            cursor: default;
        }
        .tax-savings-label {
            font-size: 0.7rem;
            color: #4a5568;
            margin-bottom: 6px;
            line-height: 1.3;
            height: 2em;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: default;
        }
        .tax-savings-value {
            font-size: 1rem;
            font-weight: 700;
            color: #1a3a5f;
            cursor: default;
        }
        
        .result-footer {
            margin-top: 18px;
            padding-top: 16px;
            border-top: 1px solid #e2e8f0;
            cursor: default;
        }
        .total-contract {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f0f7ff;
            border-radius: 10px;
            border: 1px solid #c3dafe;
            cursor: default;
        }
        .total-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #2d3748;
            cursor: default;
        }
        .total-value {
            font-size: 1.1rem;
            font-weight: 800;
            color: #1a3a5f;
            cursor: default;
        }
        
        /* 3 кнопки в форме - Telegram, Email, Звонок */
        .form-actions {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-top: 20px;
        }
        @media (max-width: 768px) {
            .form-actions { 
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
        }
        @media (max-width: 480px) {
            .form-actions { 
                grid-template-columns: 1fr; 
            }
        }
        
        .form-action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 8px;
            border: none;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            text-align: center;
            min-height: 44px;
        }
        
        /* Синяя кнопка Telegram */
        .telegram-form-btn {
            background: linear-gradient(to right, #0088cc, #0077b5);
            color: white;
        }
        
        .telegram-form-btn:hover {
            background: linear-gradient(to right, #0077b5, #006ba1);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 136, 204, 0.3);
        }
        
        /* Оранжевая кнопка Email */
        .email-form-btn {
            background: linear-gradient(to right, #e67e22, #d35400);
            color: white;
        }
        
        .email-form-btn:hover {
            background: linear-gradient(to right, #d35400, #c0392b);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(230, 126, 34, 0.3);
        }
        
        /* Зеленая кнопка телефона */
        .phone-form-btn {
            background: linear-gradient(to right, #38a169, #2f855a);
            color: white;
        }
        
        .phone-form-btn:hover {
            background: linear-gradient(to right, #2f855a, #276749);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(56, 161, 105, 0.3);
        }
        
        .open-schedule-btn-container {
            margin-top: 18px;
        }
        .open-schedule-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            background: linear-gradient(to right, #e67e22, #d35400);
            color: white;
        }
        .open-schedule-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(230, 126, 34, 0.3);
        }
        
        /* Кнопки управления */
        .percent-controls {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 8px;
        }
        
        .percent-btn {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 1px solid #cbd5e0;
            background: white;
            color: #4a5568;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .percent-btn:hover {
            background: #f0f7ff;
            border-color: #2c5282;
            color: #2c5282;
        }
        
        .percent-btn:active {
            transform: scale(0.95);
        }
        
        .percent-value-display {
            flex-grow: 1;
            text-align: center;
            font-weight: 600;
            color: #1a3a5f;
            font-size: 0.8rem;
            cursor: default;
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            padding: 15px;
        }
        .modal-content {
            background: white;
            border-radius: 15px;
            width: 100%;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            cursor: default;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e2e8f0;
            cursor: default;
        }
        .modal-title {
            font-size: 1.1rem;
            color: #1a3a5f;
            font-weight: 700;
            cursor: default;
        }
        .close-modal {
            background: none;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            color: #718096;
            padding: 5px;
        }
        .close-modal:hover {
            color: #e53e3e;
        }
        .payment-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            font-size: 0.85rem;
            cursor: default;
        }
        .payment-table th {
            background: #f7fafc;
            padding: 8px 10px;
            text-align: left;
            font-weight: 600;
            color: #2d3748;
            border-bottom: 2px solid #e2e8f0;
            font-size: 0.85rem;
            cursor: default;
        }
        .payment-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #e2e8f0;
            color: #4a5568;
            font-size: 0.85rem;
            cursor: default;
        }
        .payment-table tr:hover {
            background: #f8fafc;
        }
        .payment-table .payment-number {
            font-weight: 600;
            color: #1a3a5f;
            text-align: center;
            width: 50px;
        }
        .payment-table .advance-row {
            background: #f0fff4;
        }
        .payment-table .redemption-row {
            background: #fffaf0;
        }
        .payment-table .total-row {
            background: #f0f7ff;
            font-weight: 700;
            color: #1a3a5f;
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 16px;
            gap: 10px;
        }
        .modal-action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
        }
        .modal-print-btn {
            background: #2c5282;
            color: white;
        }
        .modal-print-btn:hover {
            background: #1a3a5f;
        }
        .modal-save-btn {
            background: #38a169;
            color: white;
        }
        .modal-save-btn:hover {
            background: #2f855a;
        }
        
        .phone-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10001;
            justify-content: center;
            align-items: center;
            padding: 15px;
        }
        .phone-modal-content {
            background: white;
            border-radius: 15px;
            width: 100%;
            max-width: 400px;
            padding: 22px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            cursor: default;
        }
        .phone-modal-title {
            font-size: 1.1rem;
            color: #1a3a5f;
            margin-bottom: 16px;
            font-weight: 600;
            cursor: default;
        }
        .phone-number-display {
            font-size: 1.5rem;
            font-weight: 700;
            color: #38a169;
            margin: 16px 0;
            padding: 12px;
            background: #f8fafc;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            cursor: default;
            user-select: text;
        }
        .phone-modal-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .phone-modal-btn {
            padding: 10px 18px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
        }
        .copy-phone-btn {
            background: #2c5282;
            color: white;
        }
        .copy-phone-btn:hover {
            background: #1a3a5f;
        }
        .close-phone-btn {
            background: #e2e8f0;
            color: #4a5568;
        }
        .close-phone-btn:hover {
            background: #cbd5e0;
        }
        .copy-success {
            color: #38a169;
            font-size: 0.8rem;
            margin-top: 8px;
            display: none;
            cursor: default;
        }
        
        .vat-amount, .profit-tax-amount {
            font-weight: 600;
            color: #2d3748;
            cursor: default;
        }
        
        /* Стиль для подсказок формул (скрыт по умолчанию) */
        .formula-hint {
            display: none;
        }
        
        /* Защита от копирования */
        .protection-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            z-index: 999999;
            pointer-events: none;
        }
        
        /* Скрытые стили для защиты */
        .hidden-protection {
            display: none;
        }
        
        /* Скрытие диапазонов для стоимости техники */
        .price-slider-container {
            margin-top: 10px;
        }
    </style>
</head>
<body class="no-copy">
    <!-- Скрытый защитный слой -->
    <div class="protection-overlay" id="protectionOverlay"></div>
    
    <!-- Скрытое поле для защиты от ботов -->
    <input type="text" class="honeypot-field" name="bot_check" autocomplete="off" tabindex="-1">
    <!-- Скрытое поле для email менеджера -->
    <input type="hidden" id="managerEmail" value="yweliq@yandex.ru">
    
    <!-- Скрытая защита -->
    <div class="hidden-protection" id="antiCopy">Защищено от копирования</div>
    <div class="hidden-protection" id="antiDevTools">DevTools заблокированы</div>
    
    <div class="container">
        <header>
            <h1><i class="fas fa-calculator"></i> Лизинговый калькулятор</h1>
            <p>Рассчитайте график платежей и налоговую экономию для вашего бизнеса</p>
            
            <!-- Верхние иконки - синий Telegram и зеленый телефон -->
            <div class="header-icons">
                <a href="https://t.me/YWeliQ" class="header-icon-link telegram-icon" target="_blank" title="Написать в Telegram" onclick="logClick('telegram_header')">
                    <i class="fab fa-telegram-plane"></i>
                </a>
                <a href="tel:+79218997395" class="header-icon-link phone-icon" title="Позвонить" onclick="logClick('phone_header')">
                    <i class="fas fa-phone"></i>
                </a>
            </div>
        </header>

        <div class="calculator-wrapper">
            <section class="input-section">
                <h2 class="section-title"><i class="fas fa-sliders-h"></i> Параметры лизинга</h2>
                
                <!-- СТОИМОСТЬ ТЕХНИКИ - от 0 до 100 млн -->
                <div class="input-group price-slider-container">
                    <div class="input-header">
                        <label for="priceInput">Стоимость техники</label>
                    </div>
                    <div class="input-with-controls">
                        <input type="text" id="priceInput" class="money-input" value="1 500 000" autocomplete="off">
                        <span class="input-suffix">₽</span>
                    </div>
                    <input type="range" id="priceSlider" class="range-slider" min="0" max="100000000" step="10000" value="1500000" style="margin-top: 10px;">
                    <!-- Диапазон скрыт (0-100 млн не отображается) -->
                </div>
                
                <!-- ПЕРВОНАЧАЛЬНЫЙ ВЗНОС -->
                <div class="input-group">
                    <div class="percent-input-container">
                        <div class="percent-display">
                            <label for="advanceSlider">Первоначальный взнос</label>
                            <div class="value-container">
                                <span class="value" id="advanceValue">20%</span>
                                <span class="value-rub" id="advanceRub">300 000 ₽</span>
                            </div>
                        </div>
                        <input type="range" id="advanceSlider" class="range-slider" min="5" max="50" step="0.1" value="20">
                        <div class="range-limits"><span>5%</span><span>50%</span></div>
                        
                        <!-- Кнопки управления с шагом 0.1% -->
                        <div class="percent-controls">
                            <button type="button" class="percent-btn" id="decreaseAdvanceBtn" onclick="adjustAdvance(-0.1)">-</button>
                            <div class="percent-value-display" id="advancePercentDisplay">20.0%</div>
                            <button type="button" class="percent-btn" id="increaseAdvanceBtn" onclick="adjustAdvance(0.1)">+</button>
                        </div>
                    </div>
                </div>
                
                <!-- СРОК ДОГОВОРА -->
                <div class="input-group">
                    <div class="percent-input-container">
                        <div class="percent-display">
                            <label for="termSlider">Срок договора</label>
                            <div class="value-container">
                                <span class="value" id="termValue">36</span>
                                <span class="value-rub">месяцев</span>
                            </div>
                        </div>
                        <input type="range" id="termSlider" class="range-slider" min="6" max="60" step="1" value="36">
                        <div class="range-limits"><span>6 мес.</span><span>60 мес.</span></div>
                        
                        <!-- Кнопки управления с шагом 1 месяц -->
                        <div class="percent-controls">
                            <button type="button" class="percent-btn" id="decreaseTermBtn" onclick="adjustTerm(-1)">-</button>
                            <div class="percent-value-display" id="termDisplay">36 мес.</div>
                            <button type="button" class="percent-btn" id="increaseTermBtn" onclick="adjustTerm(1)">+</button>
                        </div>
                    </div>
                </div>
                
                <!-- ВЫКУПНОЙ ПЛАТЕЖ -->
                <div class="input-group">
                    <div class="percent-input-container">
                        <div class="percent-display">
                            <label for="redemptionSlider">Выкупной платеж</label>
                            <div class="value-container">
                                <span class="value" id="redemptionValue">10%</span>
                                <span class="value-rub" id="redemptionRub">150 000 ₽</span>
                            </div>
                        </div>
                        <input type="range" id="redemptionSlider" class="range-slider" min="0" max="15" step="0.1" value="10">
                        <div class="range-limits"><span>0%</span><span>15%</span></div>
                        
                        <!-- Кнопки управления с шагом 0.1% -->
                        <div class="percent-controls">
                            <button type="button" class="percent-btn" id="decreaseRedemptionBtn" onclick="adjustRedemption(-0.1)">-</button>
                            <div class="percent-value-display" id="redemptionPercentDisplay">10.0%</div>
                            <button type="button" class="percent-btn" id="increaseRedemptionBtn" onclick="adjustRedemption(0.1)">+</button>
                        </div>
                    </div>
                </div>
            </section>

            <section class="result-section">
                <h2 class="section-title"><i class="fas fa-chart-bar"></i> Результаты расчета</h2>
                
                <div class="result-box result-main">
                    <div class="result-label">Ежемесячный платеж</div>
                    <div class="result-value" id="monthlyPayment">89 054 ₽</div>
                </div>
                
                <div class="result-box">
                    <div class="result-label">Налоговая экономия <i class="fas fa-question-circle info-icon" title="Экономия рассчитана в сравнении с покупкой за собственные средства"></i></div>
                    <div class="result-value" id="taxSaving">702 459 ₽</div>
                </div>
                
                <div class="tax-savings-compact">
                    <div class="tax-savings-item">
                        <div class="tax-savings-label">НДС к возмещению (22%)</div>
                        <div class="tax-savings-value" id="ndsSave">380 589 ₽</div>
                    </div>
                    <div class="tax-savings-item">
                        <div class="tax-savings-label">Экономия по налогу на прибыль (25%)</div>
                        <div class="tax-savings-value" id="profitTaxSave">321 870 ₽</div>
                    </div>
                </div>
                
                <div class="result-footer">
                    <div class="total-contract">
                        <div class="total-label">Общая стоимость договора</div>
                        <div class="total-value" id="totalAmount">3 605 944 ₽</div>
                    </div>
                </div>
                
                <div class="open-schedule-btn-container">
                    <button class="open-schedule-btn" id="openScheduleBtn" onclick="openScheduleModal()">
                        <i class="fas fa-chart-line"></i> Открыть график платежей
                    </button>
                </div>
                
                <div class="contact-form">
                    <h2 class="section-title"><i class="fas fa-user"></i> Контактная информация</h2>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="clientName">Имя <span class="form-optional">(необязательно)</span></label>
                            <input type="text" id="clientName" placeholder="Ваше имя">
                        </div>
                        <div class="form-group">
                            <label for="clientPhone">Телефон *</label>
                            <input type="tel" id="clientPhone" class="phone-input" placeholder="+7 999 123 45 67" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="clientInn">ИНН компании <span class="form-optional">(необязательно)</span></label>
                        <input type="text" id="clientInn" class="inn-input" placeholder="10 или 12 цифр" maxlength="12">
                    </div>
                    
                    <div class="checkbox-group">
                        <div class="checkbox-container">
                            <input type="checkbox" id="privacyPolicy" required>
                            <label for="privacyPolicy" class="checkbox-label">
                                Я соглашаюсь с <a href="#" target="_blank" onclick="logClick('privacy_policy')">политикой конфиденциальности</a> и даю согласие на обработку персональных данных
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="form-action-btn telegram-form-btn" id="sendTelegramBtn" onclick="sendTelegram()">
                            <i class="fab fa-telegram-plane"></i> Telegram
                        </button>
                        <button type="button" class="form-action-btn email-form-btn" id="sendEmailBtn" onclick="sendEmail()">
                            <i class="fas fa-envelope"></i> Email
                        </button>
                        <button type="button" class="form-action-btn phone-form-btn" id="showPhoneBtn" onclick="showPhoneModal()">
                            <i class="fas fa-phone"></i> Позвонить
                        </button>
                    </div>
                </div>
                
                <div class="disclaimer">
                    *Все расчеты являются предварительными. Точные условия будут рассчитаны после консультации с менеджером.
                </div>
            </section>
        </div>
    </div>

    <!-- Модальное окно графика платежей -->
    <div class="modal-overlay" id="scheduleModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">График платежей по лизингу с налоговой экономией</div>
                <button class="close-modal" id="closeScheduleModal" onclick="closeScheduleModal()">×</button>
            </div>
            
            <div class="modal-actions">
                <button class="modal-action-btn modal-print-btn" id="printScheduleBtn" onclick="printSchedule()">
                    <i class="fas fa-print"></i> Печать
                </button>
                <button class="modal-action-btn modal-save-btn" id="savePDFBtn" onclick="saveScheduleAsPDF()">
                    <i class="fas fa-file-pdf"></i> Сохранить PDF
                </button>
            </div>
            
            <table class="payment-table" id="paymentScheduleTable">
                <thead>
                    <tr>
                        <th class="payment-number">№</th>
                        <th>Дата платежа</th>
                        <th>Сумма платежа</th>
                        <th>НДС (22%)</th>
                        <th>Налог на прибыль (25%)</th>
                    </tr>
                </thead>
                <tbody id="paymentScheduleBody">
                    <!-- График будет генерироваться динамически -->
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="2">Итого:</td>
                        <td id="scheduleTotalPayment">0 ₽</td>
                        <td id="scheduleTotalVAT">0 ₽</td>
                        <td id="scheduleTotalProfitTax">0 ₽</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <!-- Модальное окно телефона -->
    <div class="phone-modal" id="phoneModal">
        <div class="phone-modal-content">
            <div class="phone-modal-title">Позвонить менеджеру</div>
            <div class="phone-number-display" id="phoneNumberDisplay">+7 921 899-73-95</div>
            <div class="phone-modal-buttons">
                <button class="phone-modal-btn copy-phone-btn" id="copyPhoneBtn" onclick="copyPhoneNumber()">Скопировать номер</button>
                <button class="phone-modal-btn close-phone-btn" id="closePhoneModal" onclick="closePhoneModal()">Закрыть</button>
            </div>
            <div class="copy-success" id="copySuccess">Номер скопирован в буфер обмена!</div>
        </div>
    </div>

    <script>
        // ============================================
        // УМНАЯ ЗАЩИТА ОТ КОПИРОВАНИЯ (только для десктопов)
        // ============================================

        function setupSmartProtection() {
            // Проверяем, мобильное ли устройство
            const isMobile = /iPhone|iPad|iPod|Android|webOS|BlackBerry|Windows Phone/i.test(navigator.userAgent);
            
            if (isMobile) {
                console.log('Мобильное устройство - защита отключена');
                return; // На мобильных защиту не включаем
            }
            
            console.log('Десктоп - защита активирована');
            
            // 1. Защита от открытия DevTools (только F12)
            document.addEventListener('keydown', function(e) {
                // Только F12 блокируем
                if (e.key === 'F12' || e.keyCode === 123) {
                    e.preventDefault();
                    // Без alert, просто блокируем
                    console.log('F12 заблокирован');
                    return false;
                }
            });
            
            // 2. Защита от контекстного меню (правой кнопки мыши) - мягкая
            document.addEventListener('contextmenu', function(e) {
                // Всегда разрешаем контекстное меню для:
                if (e.target.closest('.phone-number-display') || 
                    e.target.closest('.money-input') || 
                    e.target.closest('.phone-input') || 
                    e.target.closest('.inn-input') ||
                    e.target.closest('#clientName') ||
                    e.target.tagName === 'INPUT' ||
                    e.target.tagName === 'TEXTAREA') {
                    return true; // Разрешаем
                }
                
                // Для остальных элементов можно показать предупреждение один раз
                if (!localStorage.getItem('contextMenuWarned')) {
                    // e.preventDefault();
                    // Можно показать сообщение, но не блокировать
                    console.log('Контекстное меню не рекомендуется');
                    localStorage.setItem('contextMenuWarned', 'true');
                }
                return true; // Всегда разрешаем, но логируем
            });
            
            // 3. Защита от копирования (Ctrl+C) - мягкая
            document.addEventListener('copy', function(e) {
                // Всегда разрешаем копирование из полей ввода
                if (e.target.closest('.phone-number-display') || 
                    e.target.closest('.money-input') || 
                    e.target.closest('.phone-input') || 
                    e.target.closest('.inn-input') ||
                    e.target.closest('#clientName') ||
                    e.target.tagName === 'INPUT' ||
                    e.target.tagName === 'TEXTAREA') {
                    return true;
                }
                
                // Для остального контента - разрешаем, но логируем
                const selection = window.getSelection().toString();
                if (selection.length > 50) {
                    console.log('Попытка копирования контента:', selection.substring(0, 100) + '...');
                    // Можно отправить в аналитику
                }
                return true; // Всегда разрешаем копирование
            });
            
            // 4. Обнаружение DevTools (только для информации)
            let devToolsOpened = false;
            
            function checkDevTools() {
                const widthThreshold = window.outerWidth - window.innerWidth > 100;
                const heightThreshold = window.outerHeight - window.innerHeight > 100;
                
                if ((widthThreshold || heightThreshold) && !devToolsOpened) {
                    devToolsOpened = true;
                    console.log('DevTools обнаружены (информационно)');
                    // Только логируем, не блокируем
                }
            }
            
            // Проверяем реже (раз в 2 секунды)
            setInterval(checkDevTools, 2000);
            
            // 5. Защита от drag-and-drop (только для изображений)
            document.addEventListener('dragstart', function(e) {
                if (e.target.tagName === 'IMG') {
                    e.preventDefault();
                    return false;
                }
                return true;
            });
        }

        // ============================================
        // СОХРАНЕНИЕ ГРАФИКА В PDF (умный способ)
        // ============================================

        function saveScheduleAsPDF() {
            // Сначала генерируем график платежей
            generatePaymentSchedule();
            
            // Получаем данные для PDF
            const equipmentCostFormatted = priceInput.value;
            const advanceFormatted = `${advanceValue.textContent} (${advanceRub.textContent})`;
            const termFormatted = `${termValue.textContent} месяцев`;
            const redemptionFormatted = `${redemptionValue.textContent} (${redemptionRub.textContent})`;
            const monthlyPaymentFormatted = monthlyPayment.textContent;
            const totalAmountFormatted = totalAmount.textContent;
            const ndsEconomyFormatted = ndsSave.textContent;
            const profitTaxEconomyFormatted = profitTaxSave.textContent;
            const today = new Date().toLocaleDateString('ru-RU');
            
            // Создаем HTML для сохранения
            const htmlContent = `
                <!DOCTYPE html>
                <html lang="ru">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>График платежей по лизингу</title>
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
                        
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                            font-family: 'Roboto', 'Segoe UI', Arial, sans-serif;
                        }
                        
                        body {
                            padding: 25px;
                            color: #333;
                            line-height: 1.5;
                            background: white;
                        }
                        
                        .pdf-container {
                            max-width: 1000px;
                            margin: 0 auto;
                        }
                        
                        .pdf-header {
                            text-align: center;
                            margin-bottom: 30px;
                            padding-bottom: 15px;
                            border-bottom: 3px solid #2c5282;
                        }
                        
                        .pdf-title {
                            color: #1a3a5f;
                            font-size: 24px;
                            margin-bottom: 10px;
                            font-weight: 700;
                        }
                        
                        .pdf-subtitle {
                            color: #4a5568;
                            font-size: 16px;
                            font-weight: 500;
                        }
                        
                        .pdf-date {
                            text-align: right;
                            color: #718096;
                            font-size: 14px;
                            margin-bottom: 25px;
                            padding-bottom: 10px;
                            border-bottom: 1px solid #e2e8f0;
                        }
                        
                        .info-section {
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 20px;
                            margin-bottom: 30px;
                            background: #f8fafc;
                            padding: 20px;
                            border-radius: 10px;
                            border: 1px solid #e2e8f0;
                        }
                        
                        .info-row {
                            margin-bottom: 12px;
                        }
                        
                        .info-label {
                            font-weight: 600;
                            color: #4a5568;
                            font-size: 14px;
                            margin-bottom: 4px;
                        }
                        
                        .info-value {
                            color: #1a3a5f;
                            font-weight: 700;
                            font-size: 16px;
                        }
                        
                        .payment-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 15px;
                            margin-bottom: 30px;
                            font-size: 13px;
                        }
                        
                        .payment-table th {
                            background: #2c5282;
                            color: white;
                            padding: 12px 10px;
                            text-align: left;
                            font-weight: 600;
                            border: 1px solid #1a3a5f;
                            font-size: 13px;
                        }
                        
                        .payment-table td {
                            padding: 10px;
                            border: 1px solid #e2e8f0;
                            color: #4a5568;
                            font-size: 13px;
                        }
                        
                        .payment-table tr:nth-child(even) {
                            background: #f8fafc;
                        }
                        
                        .payment-table .advance-row {
                            background: #f0fff4 !important;
                        }
                        
                        .payment-table .redemption-row {
                            background: #fffaf0 !important;
                        }
                        
                        .payment-table .total-row {
                            background: #f0f7ff !important;
                            font-weight: 700;
                            color: #1a3a5f;
                        }
                        
                        .tax-summary {
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 20px;
                            margin: 30px 0;
                            background: #f8fafc;
                            padding: 20px;
                            border-radius: 10px;
                            border: 1px solid #e2e8f0;
                        }
                        
                        .tax-item {
                            margin-bottom: 10px;
                        }
                        
                        .tax-label {
                            font-weight: 600;
                            color: #4a5568;
                            font-size: 14px;
                            margin-bottom: 5px;
                        }
                        
                        .tax-value {
                            color: #1a3a5f;
                            font-weight: 700;
                            font-size: 18px;
                        }
                        
                        .pdf-footer {
                            margin-top: 40px;
                            padding-top: 20px;
                            border-top: 2px solid #e2e8f0;
                            font-size: 12px;
                            color: #718096;
                            line-height: 1.6;
                        }
                        
                        .disclaimer {
                            margin-top: 10px;
                            font-style: italic;
                        }
                        
                        .company-info {
                            margin-top: 20px;
                            padding: 15px;
                            background: #f0f7ff;
                            border-radius: 8px;
                            border: 1px solid #c3dafe;
                        }
                        
                        .company-title {
                            font-weight: 700;
                            color: #2c5282;
                            margin-bottom: 10px;
                        }
                        
                        @media print {
                            body {
                                padding: 15px;
                            }
                            
                            .no-print {
                                display: none;
                            }
                            
                            .payment-table {
                                page-break-inside: avoid;
                            }
                            
                            .info-section, .tax-summary {
                                page-break-inside: avoid;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="pdf-container">
                        <div class="pdf-header">
                            <h1 class="pdf-title">График платежей по лизингу</h1>
                            <div class="pdf-subtitle">Детализированный расчет с налоговой экономией</div>
                        </div>
                        
                        <div class="pdf-date">
                            Дата формирования: ${today}
                        </div>
                        
                        <div class="info-section">
                            <div class="info-row">
                                <div class="info-label">Стоимость техники:</div>
                                <div class="info-value">${equipmentCostFormatted} ₽</div>
                            </div>
                            <div class="info-row">
                                <div class="info-label">Первоначальный взнос:</div>
                                <div class="info-value">${advanceFormatted}</div>
                            </div>
                            <div class="info-row">
                                <div class="info-label">Срок договора:</div>
                                <div class="info-value">${termFormatted}</div>
                            </div>
                            <div class="info-row">
                                <div class="info-label">Выкупной платеж:</div>
                                <div class="info-value">${redemptionFormatted}</div>
                            </div>
                            <div class="info-row">
                                <div class="info-label">Ежемесячный платеж:</div>
                                <div class="info-value">${monthlyPaymentFormatted}</div>
                            </div>
                            <div class="info-row">
                                <div class="info-label">Общая стоимость договора:</div>
                                <div class="info-value">${totalAmountFormatted}</div>
                            </div>
                        </div>
                        
                        <h2 style="color: #1a3a5f; margin-bottom: 15px; font-size: 20px;">Детальный график платежей</h2>
                        
                        ${document.getElementById('paymentScheduleTable').outerHTML}
                        
                        <div class="tax-summary">
                            <div class="tax-item">
                                <div class="tax-label">НДС к возмещению (22%):</div>
                                <div class="tax-value">${ndsEconomyFormatted}</div>
                            </div>
                            <div class="tax-item">
                                <div class="tax-label">Экономия по налогу на прибыль (25%):</div>
                                <div class="tax-value">${profitTaxEconomyFormatted}</div>
                            </div>
                            <div class="tax-item">
                                <div class="tax-label">Общая налоговая экономия:</div>
                                <div class="tax-value">${taxSaving.textContent}</div>
                            </div>
                            <div class="tax-item">
                                <div class="tax-label">Эффективная ставка по договору:</div>
                                <div class="tax-value">${(baseRate + markupPercent).toFixed(1)}% годовых</div>
                            </div>
                        </div>
                        
                        <div class="company-info">
                            <div class="company-title">Контакты для связи:</div>
                            <div style="margin-bottom: 8px;"><strong>Телефон:</strong> +7 921 899-73-95</div>
                            <div style="margin-bottom: 8px;"><strong>Telegram:</strong> @YWeliQ</div>
                            <div style="margin-bottom: 8px;"><strong>Email:</strong> yweliq@yandex.ru</div>
                        </div>
                        
                        <div class="pdf-footer">
                            <p><strong>Примечания:</strong></p>
                            <p>1. Все расчеты являются предварительными и носят информационный характер.</p>
                            <p>2. Точные условия лизинга будут рассчитаны после консультации с менеджером.</p>
                            <p>3. НДС рассчитывается по ставке 22%, налог на прибыль по ставке 25%.</p>
                            <p>4. В расчетах учтена налоговая экономия при использовании лизинга в сравнении с покупкой за собственные средства.</p>
                            
                            <div class="disclaimer">
                                *Данный документ сгенерирован автоматически с помощью лизингового калькулятора.
                            </div>
                        </div>
                    </div>
                    
                    <div class="no-print" style="margin-top: 30px; text-align: center;">
                        <button onclick="window.print()" style="padding: 12px 24px; background: #2c5282; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
                            🖨️ Печать документа
                        </button>
                        <button onclick="window.close()" style="padding: 12px 24px; background: #718096; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; margin-left: 10px;">
                            ✕ Закрыть окно
                        </button>
                    </div>
                    
                    <script>
                        // Автоматически открываем диалог печати через 500мс
                        setTimeout(() => {
                            window.print();
                        }, 500);
                    </script>
                </body>
                </html>
            `;
            
            // Создаем новое окно для печати/сохранения
            const printWindow = window.open('', '_blank', 'width=1200,height=800');
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            
            // Даем время на загрузку
            setTimeout(() => {
                printWindow.focus();
                // Автоматически открываем диалог печати
                // Пользователь может выбрать "Сохранить как PDF"
                printWindow.print();
            }, 800);
        }

        // ============================================
        // ОСНОВНОЙ КОД КАЛЬКУЛЯТОРА
        // ============================================
        
        // Основные переменные
        let equipmentCost = 1500000;
        let advancePercent = 20.0;
        let termMonths = 36;
        let redemptionPercent = 10.0;
        const baseRate = 17; // Базовая ставка 17%
        const markupPercent = 14; // Наценка 14%
        
        // Элементы DOM
        const priceInput = document.getElementById('priceInput');
        const priceSlider = document.getElementById('priceSlider');
        const advanceSlider = document.getElementById('advanceSlider');
        const advanceValue = document.getElementById('advanceValue');
        const advanceRub = document.getElementById('advanceRub');
        const advancePercentDisplay = document.getElementById('advancePercentDisplay');
        const termSlider = document.getElementById('termSlider');
        const termValue = document.getElementById('termValue');
        const termDisplay = document.getElementById('termDisplay');
        const redemptionSlider = document.getElementById('redemptionSlider');
        const redemptionValue = document.getElementById('redemptionValue');
        const redemptionRub = document.getElementById('redemptionRub');
        const redemptionPercentDisplay = document.getElementById('redemptionPercentDisplay');
        
        // Результаты
        const monthlyPayment = document.getElementById('monthlyPayment');
        const taxSaving = document.getElementById('taxSaving');
        const ndsSave = document.getElementById('ndsSave');
        const profitTaxSave = document.getElementById('profitTaxSave');
        const totalAmount = document.getElementById('totalAmount');
        
        // Модальные окна
        const scheduleModal = document.getElementById('scheduleModal');
        const paymentScheduleBody = document.getElementById('paymentScheduleBody');
        const scheduleTotalPayment = document.getElementById('scheduleTotalPayment');
        const scheduleTotalVAT = document.getElementById('scheduleTotalVAT');
        const scheduleTotalProfitTax = document.getElementById('scheduleTotalProfitTax');
        const phoneModal = document.getElementById('phoneModal');
        
        // Форматирование чисел
        function formatNumber(num) {
            if (num === 0) return '0';
            return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
        }
        
        function parseFormattedNumber(str) {
            return parseFloat(str.replace(/\s/g, '')) || 0;
        }
        
        // Обновление стоимости техники (от 0 до 100 млн)
        function updateEquipmentCost() {
            let value = parseFormattedNumber(priceInput.value);
            
            // Проверяем допустимый диапазон
            if (value < 0) value = 0;
            if (value > 100000000) value = 100000000;
            
            // Если поле пустое или 0, устанавливаем минимальное значение
            if (!value || value < 0) {
                value = 0;
                priceInput.value = '0';
            }
            
            // Обновляем слайдер и поле ввода
            priceSlider.value = value;
            if (value > 0) {
                priceInput.value = formatNumber(value);
            } else {
                priceInput.value = '0';
            }
            
            equipmentCost = value;
            updateAdvanceValue();
            updateRedemptionValue();
            calculateLeasing();
        }
        
        // Регулировка первоначального взноса
        function adjustAdvance(delta) {
            let value = parseFloat(advanceSlider.value);
            value += delta;
            value = Math.max(5, Math.min(50, value));
            advanceSlider.value = value.toFixed(1);
            updateAdvanceValue();
        }
        
        function updateAdvanceValue() {
            advancePercent = parseFloat(advanceSlider.value);
            const advanceRubValue = (equipmentCost * advancePercent / 100);
            
            advanceValue.textContent = `${advancePercent.toFixed(1)}%`;
            advanceRub.textContent = `${formatNumber(advanceRubValue)} ₽`;
            advancePercentDisplay.textContent = `${advancePercent.toFixed(1)}%`;
            
            calculateLeasing();
        }
        
        // Регулировка срока договора
        function adjustTerm(delta) {
            let value = parseInt(termSlider.value);
            value += delta;
            value = Math.max(6, Math.min(60, value));
            termSlider.value = value;
            updateTermValue();
        }
        
        function updateTermValue() {
            termMonths = parseInt(termSlider.value);
            termValue.textContent = termMonths;
            termDisplay.textContent = `${termMonths} мес.`;
            
            calculateLeasing();
        }
        
        // Регулировка выкупного платежа
        function adjustRedemption(delta) {
            let value = parseFloat(redemptionSlider.value);
            value += delta;
            value = Math.max(0, Math.min(15, value));
            redemptionSlider.value = value.toFixed(1);
            updateRedemptionValue();
        }
        
        function updateRedemptionValue() {
            redemptionPercent = parseFloat(redemptionSlider.value);
            const redemptionRubValue = (equipmentCost * redemptionPercent / 100);
            
            redemptionValue.textContent = `${redemptionPercent.toFixed(1)}%`;
            redemptionRub.textContent = `${formatNumber(redemptionRubValue)} ₽`;
            redemptionPercentDisplay.textContent = `${redemptionPercent.toFixed(1)}%`;
            
            calculateLeasing();
        }
        
        // Расчет лизинга с базовой ставкой 17% и наценкой 14%
        function calculateLeasing() {
            const advancePercentValue = parseFloat(advanceSlider.value);
            const termValue = parseInt(termSlider.value);
            const redemptionPercentValue = parseFloat(redemptionSlider.value);
            
            // Проверяем, что стоимость техники не равна 0
            if (equipmentCost === 0) {
                monthlyPayment.textContent = '0 ₽';
                taxSaving.textContent = '0 ₽';
                ndsSave.textContent = '0 ₽';
                profitTaxSave.textContent = '0 ₽';
                totalAmount.textContent = '0 ₽';
                return;
            }
            
            // Расчеты
            const advancePayment = equipmentCost * advancePercentValue / 100;
            const redemptionPayment = equipmentCost * redemptionPercentValue / 100;
            const leasingAmount = equipmentCost - advancePayment;
            
            // Если сумма лизинга равна 0 (100% аванс)
            if (leasingAmount <= 0) {
                monthlyPayment.textContent = '0 ₽';
                const totalContractValue = advancePayment + redemptionPayment;
                
                // НОВАЯ ФОРМУЛА РАСЧЕТА НАЛОГОВ
                const ndsEconomy = Math.round(totalContractValue * 0.22 / 1.22);
                const profitTaxEconomy = Math.round((totalContractValue - ndsEconomy) * 0.25);
                const totalTaxEconomy = ndsEconomy + profitTaxEconomy;
                
                taxSaving.textContent = `${formatNumber(totalTaxEconomy)} ₽`;
                ndsSave.textContent = `${formatNumber(ndsEconomy)} ₽`;
                profitTaxSave.textContent = `${formatNumber(profitTaxEconomy)} ₽`;
                totalAmount.textContent = `${formatNumber(totalContractValue)} ₽`;
                return;
            }
            
            // Процентная ставка 17% годовых + наценка 14%
            const annualRate = baseRate + markupPercent; // 31% годовых
            const monthlyRate = annualRate / 12 / 100;
            
            // Расчет аннуитетного платежа
            const monthlyPaymentValue = leasingAmount * (monthlyRate * Math.pow(1 + monthlyRate, termValue)) / (Math.pow(1 + monthlyRate, termValue) - 1);
            
            // Общая сумма лизинговых платежей
            const totalLeasingPayments = monthlyPaymentValue * termValue;
            
            // Общая стоимость договора
            const totalContractValue = advancePayment + totalLeasingPayments + redemptionPayment;
            
            // НОВАЯ ФОРМУЛА РАСЧЕТА НАЛОГОВОЙ ЭКОНОМИИ
            const ndsEconomy = Math.round(totalContractValue * 0.22 / 1.22);
            const profitTaxEconomy = Math.round((totalContractValue - ndsEconomy) * 0.25);
            const totalTaxEconomy = ndsEconomy + profitTaxEconomy;
            
            // Обновление UI
            monthlyPayment.textContent = `${formatNumber(monthlyPaymentValue)} ₽`;
            taxSaving.textContent = `${formatNumber(totalTaxEconomy)} ₽`;
            ndsSave.textContent = `${formatNumber(ndsEconomy)} ₽`;
            profitTaxSave.textContent = `${formatNumber(profitTaxEconomy)} ₽`;
            totalAmount.textContent = `${formatNumber(totalContractValue)} ₽`;
        }
        
        // Генерация графика платежей с НДС и налогом на прибыль для каждого платежа
        function generatePaymentSchedule() {
            const advancePercentValue = parseFloat(advanceSlider.value);
            const termValue = parseInt(termSlider.value);
            const redemptionPercentValue = parseFloat(redemptionSlider.value);
            
            const advancePayment = equipmentCost * advancePercentValue / 100;
            const redemptionPayment = equipmentCost * redemptionPercentValue / 100;
            const leasingAmount = equipmentCost - advancePayment;
            
            // Очистка таблицы
            paymentScheduleBody.innerHTML = '';
            
            let totalPayments = 0;
            let totalVAT = 0;
            let totalProfitTax = 0;
            const today = new Date();
            
            // Если стоимость техники 0
            if (equipmentCost === 0) {
                scheduleTotalPayment.textContent = '0 ₽';
                scheduleTotalVAT.textContent = '0 ₽';
                scheduleTotalProfitTax.textContent = '0 ₽';
                return;
            }
            
            // Добавление авансового платежа (ПЕРВЫЙ - с названием "Аванс")
            if (advancePayment > 0) {
                const advanceVAT = Math.round(advancePayment * 0.22 / 1.22);
                const advanceProfitTax = Math.round((advancePayment - advanceVAT) * 0.25);
                
                const advanceRow = document.createElement('tr');
                advanceRow.className = 'advance-row';
                advanceRow.innerHTML = `
                    <td class="payment-number">Аванс</td>
                    <td>${today.toLocaleDateString('ru-RU')}</td>
                    <td>${formatNumber(advancePayment)} ₽</td>
                    <td>${formatNumber(advanceVAT)} ₽</td>
                    <td>${formatNumber(advanceProfitTax)} ₽</td>
                `;
                paymentScheduleBody.appendChild(advanceRow);
                
                totalPayments += advancePayment;
                totalVAT += advanceVAT;
                totalProfitTax += advanceProfitTax;
            }
            
            // Если сумма лизинга больше 0, добавляем ежемесячные платежи (номера 1, 2, 3... до 36)
            if (leasingAmount > 0) {
                // Процентная ставка с наценкой (31%)
                const annualRate = baseRate + markupPercent;
                const monthlyRate = annualRate / 12 / 100;
                
                // Аннуитетный платеж
                const monthlyPaymentValue = leasingAmount * (monthlyRate * Math.pow(1 + monthlyRate, termValue)) / (Math.pow(1 + monthlyRate, termValue) - 1);
                
                // Расчет НДС и налога на прибыль для каждого ежемесячного платежа
                const monthlyVAT = Math.round(monthlyPaymentValue * 0.22 / 1.22);
                const monthlyProfitTax = Math.round((monthlyPaymentValue - monthlyVAT) * 0.25);
                
                // Добавление ежемесячных платежей (номера 1, 2, 3... до termValue)
                for (let i = 1; i <= termValue; i++) {
                    // Расчет даты платежа
                    const paymentDate = new Date(today);
                    paymentDate.setMonth(paymentDate.getMonth() + i);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="payment-number">${i}</td>
                        <td>${paymentDate.toLocaleDateString('ru-RU')}</td>
                        <td>${formatNumber(monthlyPaymentValue)} ₽</td>
                        <td>${formatNumber(monthlyVAT)} ₽</td>
                        <td>${formatNumber(monthlyProfitTax)} ₽</td>
                    `;
                    paymentScheduleBody.appendChild(row);
                    
                    totalPayments += monthlyPaymentValue;
                    totalVAT += monthlyVAT;
                    totalProfitTax += monthlyProfitTax;
                }
            }
            
            // Добавление выкупного платежа (ПОСЛЕДНИЙ - с названием "Выкупной платеж")
            if (redemptionPayment > 0) {
                const redemptionDate = new Date(today);
                redemptionDate.setMonth(redemptionDate.getMonth() + termValue + 1);
                
                const redemptionVAT = Math.round(redemptionPayment * 0.22 / 1.22);
                const redemptionProfitTax = Math.round((redemptionPayment - redemptionVAT) * 0.25);
                
                const redemptionRow = document.createElement('tr');
                redemptionRow.className = 'redemption-row';
                redemptionRow.innerHTML = `
                    <td class="payment-number">Выкупной<br>платеж</td>
                    <td>${redemptionDate.toLocaleDateString('ru-RU')}</td>
                    <td>${formatNumber(redemptionPayment)} ₽</td>
                    <td>${formatNumber(redemptionVAT)} ₽</td>
                    <td>${formatNumber(redemptionProfitTax)} ₽</td>
                `;
                paymentScheduleBody.appendChild(redemptionRow);
                
                totalPayments += redemptionPayment;
                totalVAT += redemptionVAT;
                totalProfitTax += redemptionProfitTax;
            }
            
            // Обновление итоговых сумм
            scheduleTotalPayment.textContent = `${formatNumber(totalPayments)} ₽`;
            scheduleTotalVAT.textContent = `${formatNumber(totalVAT)} ₽`;
            scheduleTotalProfitTax.textContent = `${formatNumber(totalProfitTax)} ₽`;
        }
        
        // Функция печати графика платежей (обновленная)
        function printSchedule() {
            // Создаем временное окно для печати
            const printWindow = window.open('', '_blank', 'width=900,height=600');
            
            // Получаем данные для печати
            const equipmentCostFormatted = priceInput.value;
            const advanceFormatted = `${advanceValue.textContent} (${advanceRub.textContent})`;
            const termFormatted = `${termValue.textContent} месяцев`;
            const redemptionFormatted = `${redemptionValue.textContent} (${redemptionRub.textContent})`;
            const monthlyPaymentFormatted = monthlyPayment.textContent;
            const totalAmountFormatted = totalAmount.textContent;
            const ndsEconomyFormatted = ndsSave.textContent;
            const profitTaxEconomyFormatted = profitTaxSave.textContent;
            
            // Получаем HTML таблицы
            const tableHTML = document.getElementById('paymentScheduleTable').outerHTML;
            
            // Создаем HTML для печати
            const printHTML = `
                <!DOCTYPE html>
                <html lang="ru">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>График платежей по лизингу</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { color: #1a3a5f; text-align: center; margin-bottom: 20px; }
                        .info-section { 
                            display: grid; 
                            grid-template-columns: 1fr 1fr; 
                            gap: 15px; 
                            margin-bottom: 25px;
                            background: #f8fafc;
                            padding: 15px;
                            border-radius: 8px;
                        }
                        .info-row { margin-bottom: 8px; }
                        .info-label { font-weight: bold; color: #4a5568; font-size: 13px; }
                        .info-value { color: #1a3a5f; font-weight: 600; }
                        .print-date { text-align: right; font-size: 12px; color: #666; margin-bottom: 15px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
                        th { background-color: #f2f2f2; padding: 8px; text-align: left; border: 1px solid #ddd; font-weight: bold; }
                        td { padding: 8px; border: 1px solid #ddd; }
                        .advance-row { background-color: #f0fff4; }
                        .redemption-row { background-color: #fffaf0; }
                        .total-row { background-color: #f0f7ff; font-weight: bold; }
                        .tax-summary { 
                            margin-top: 20px; 
                            background: #f8fafc; 
                            padding: 15px; 
                            border-radius: 8px;
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 15px;
                        }
                        .tax-item { margin-bottom: 8px; }
                        .tax-label { font-weight: bold; color: #4a5568; }
                        .tax-value { color: #1a3a5f; font-weight: 600; }
                        @media print {
                            body { padding: 10px; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <h1>График платежей по лизингу</h1>
                    
                    <div class="print-date">
                        Дата формирования: ${new Date().toLocaleDateString('ru-RU')}
                    </div>
                    
                    <div class="info-section">
                        <div class="info-row">
                            <div class="info-label">Стоимость техники:</div>
                            <div class="info-value">${equipmentCostFormatted} ₽</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Первоначальный взнос:</div>
                            <div class="info-value">${advanceFormatted}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Срок договора:</div>
                            <div class="info-value">${termFormatted}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Выкупной платеж:</div>
                            <div class="info-value">${redemptionFormatted}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Ежемесячный платеж:</div>
                            <div class="info-value">${monthlyPaymentFormatted}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Общая стоимость:</div>
                            <div class="info-value">${totalAmountFormatted}</div>
                        </div>
                    </div>
                    
                    ${tableHTML}
                    
                    <div class="tax-summary">
                        <div class="tax-item">
                            <div class="tax-label">Общий НДС к возмещению:</div>
                            <div class="tax-value">${ndsEconomyFormatted}</div>
                        </div>
                        <div class="tax-item">
                            <div class="tax-label">Общая экономия по налогу на прибыль:</div>
                            <div class="tax-value">${profitTaxEconomyFormatted}</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; font-size: 11px; color: #666; padding: 10px; border-top: 1px solid #e2e8f0;">
                        <p>*Все расчеты являются предварительными. Точные условия будут рассчитаны после консультации с менеджером.</p>
                        <p>**НДС рассчитывается по ставке 22%, налог на прибыль по ставке 25%.</p>
                    </div>
                    
                    <div class="no-print" style="margin-top: 30px; text-align: center;">
                        <button onclick="window.print()" style="padding: 10px 20px; background: #2c5282; color: white; border: none; border-radius: 5px; cursor: pointer;">Распечатать</button>
                        <button onclick="window.close()" style="padding: 10px 20px; background: #718096; color: white; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">Закрыть</button>
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(printHTML);
            printWindow.document.close();
            
            // Даем время на загрузку контента
            setTimeout(() => {
                printWindow.focus();
                // Автоматически открываем окно печати
                printWindow.print();
            }, 500);
        }
        
        // Управление модальными окнами
        function openScheduleModal() {
            generatePaymentSchedule();
            scheduleModal.style.display = 'flex';
        }
        
        function closeScheduleModal() {
            scheduleModal.style.display = 'none';
        }
        
        function showPhoneModal() {
            phoneModal.style.display = 'flex';
        }
        
        function closePhoneModal() {
            phoneModal.style.display = 'none';
            document.getElementById('copySuccess').style.display = 'none';
        }
        
        function copyPhoneNumber() {
            const phoneNumber = '+79218997395';
            navigator.clipboard.writeText(phoneNumber).then(function() {
                document.getElementById('copySuccess').style.display = 'block';
                setTimeout(function() {
                    document.getElementById('copySuccess').style.display = 'none';
                }, 2000);
            }).catch(function(err) {
                console.error('Ошибка копирования:', err);
            });
        }
        
        // Обработчики формы
        function sendTelegram() {
            const phone = document.getElementById('clientPhone').value.trim();
            const name = document.getElementById('clientName').value.trim();
            const inn = document.getElementById('clientInn').value.trim();
            const privacyChecked = document.getElementById('privacyPolicy').checked;
            
            if (!phone) {
                alert('Пожалуйста, укажите номер телефона');
                return;
            }
            
            if (!privacyChecked) {
                alert('Пожалуйста, согласитесь с политикой конфиденциальности');
                return;
            }
            
            const message = `Новая заявка с калькулятора:%0A%0AИмя: ${name || 'Не указано'}%0AТелефон: ${phone}%0AИНН: ${inn || 'Не указано'}%0A%0AПараметры лизинга:%0AСтоимость: ${priceInput.value} ₽%0AВзнос: ${advanceValue.textContent}%0AСрок: ${termValue.textContent} мес.%0AВыкуп: ${redemptionValue.textContent}%0A%0AЕжемесячный платеж: ${monthlyPayment.textContent}`;
            
            window.open(`https://t.me/YWeliQ?text=${message}`, '_blank');
        }
        
        function sendEmail() {
            const phone = document.getElementById('clientPhone').value.trim();
            const name = document.getElementById('clientName').value.trim();
            const inn = document.getElementById('clientInn').value.trim();
            const privacyChecked = document.getElementById('privacyPolicy').checked;
            
            if (!phone) {
                alert('Пожалуйста, укажите номер телефона');
                return;
            }
            
            if (!privacyChecked) {
                alert('Пожалуйста, согласитесь с политикой конфиденциальности');
                return;
            }
            
            const subject = 'Заявка с лизингового калькулятора';
            const body = `Новая заявка с калькулятора:\n\nИмя: ${name || 'Не указано'}\nТелефон: ${phone}\nИНН: ${inn || 'Не указано'}\n\nПараметры лизинга:\nСтоимость: ${priceInput.value} ₽\nВзнос: ${advanceValue.textContent}\nСрок: ${termValue.textContent} мес.\nВыкуп: ${redemptionValue.textContent}\n\nЕжемесячный платеж: ${monthlyPayment.textContent}`;
            
            window.location.href = `mailto:yweliq@yandex.ru?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        }
        
        // Маска для телефона
        function setupPhoneMask() {
            const phoneInput = document.getElementById('clientPhone');
            
            phoneInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                
                if (value.startsWith('7') || value.startsWith('8')) {
                    value = value.substring(1);
                }
                
                if (value.length > 0) {
                    let formatted = '+7 ';
                    
                    if (value.length > 0) {
                        formatted += value.substring(0, 3);
                    }
                    if (value.length > 3) {
                        formatted += ' ' + value.substring(3, 6);
                    }
                    if (value.length > 6) {
                        formatted += ' ' + value.substring(6, 8);
                    }
                    if (value.length > 8) {
                        formatted += ' ' + value.substring(8, 10);
                    }
                    
                    e.target.value = formatted;
                } else {
                    e.target.value = '';
                }
            });
        }
        
        // Валидация ИНН
        function setupInnValidation() {
            const innInput = document.getElementById('clientInn');
            
            innInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                
                // Ограничиваем длину ИНН (10 или 12 цифр)
                if (value.length > 12) {
                    value = value.substring(0, 12);
                }
                
                e.target.value = value;
            });
        }
        
        // Логирование кликов (для аналитики)
        function logClick(action) {
            console.log(`Клик: ${action} - ${new Date().toISOString()}`);
        }
        
        // Инициализация
        function init() {
            // Активация умной защиты (только для десктопов)
            setupSmartProtection();
            
            // Настройка обработчиков
            priceSlider.addEventListener('input', function() {
                const value = parseInt(this.value);
                priceInput.value = formatNumber(value);
                equipmentCost = value;
                updateAdvanceValue();
                updateRedemptionValue();
                calculateLeasing();
            });
            
            priceInput.addEventListener('input', updateEquipmentCost);
            priceInput.addEventListener('blur', updateEquipmentCost);
            
            advanceSlider.addEventListener('input', updateAdvanceValue);
            termSlider.addEventListener('input', updateTermValue);
            redemptionSlider.addEventListener('input', updateRedemptionValue);
            
            // Закрытие модальных окон по клику на фон
            scheduleModal.addEventListener('click', function(e) {
                if (e.target === scheduleModal) {
                    closeScheduleModal();
                }
            });
            
            phoneModal.addEventListener('click', function(e) {
                if (e.target === phoneModal) {
                    closePhoneModal();
                }
            });
            
            // Настройка масок
            setupPhoneMask();
            setupInnValidation();
            
            // Первоначальный расчет
            updateEquipmentCost();
            updateAdvanceValue();
            updateTermValue();
            updateRedemptionValue();
            calculateLeasing();
            
            console.log('Калькулятор инициализирован с умной защитой и сохранением PDF');
        }
        
        // Запуск инициализации при загрузке
        document.addEventListener('DOMContentLoaded', init);
        
    </script>
</body>
</html>
